<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Split Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        /* ç”»é¢æœ€å¤§åŒ–ã®é©ç”¨ (Req 5 & ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›1) */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6; 
            width: 100vw;
            height: 100vh;
            overflow: hidden; 
        }
        
        /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦é«˜ã•ã‚’èª¿æ•´ (6rem ã‹ã‚‰ 4rem ã«ç¸®å°) */
        .puzzle-area { min-height: 4rem; } 
        
        /* å˜èªãƒ‘ãƒ¼ãƒ„ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .word-part, .completed-word, .translation-part, .theme-item {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-width: 4px; 
            border-style: solid; 
            border-color: transparent;
        }
        
        /* é¸æŠçŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .selected { 
            box-shadow: 0 6px 12px rgba(79, 70, 229, 0.7); 
            border-color: rgb(79, 70, 229) !important; /* indigo-600 */
        }
        
        .correct-slot { background-color: #34d399 !important; } /* Tailwind green-400 */
        .incorrect-slot { background-color: #f87171 !important; } /* Tailwind red-400 */
        /* ã‚¨ãƒ©ãƒ¼æ™‚ã«ä¸€æ™‚çš„ã«èµ¤ãã™ã‚‹ãƒ”ãƒ¼ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .incorrect-part-temp { background-color: #fca5a5 !important; } /* Tailwind red-300 */

        /* ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¹ãƒ­ãƒƒãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ - line-heightã‚’å‰Šé™¤ã—ã€flexboxã«ä¾å­˜ */
        .target-slot {
            transition: background-color 0.2s;
            /* line-height: 5rem; ã‚’å‰Šé™¤ */
            font-weight: 900; 
        }
        
        /* ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢/ã‚ªãƒ¼ãƒãƒ¼æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç”¨ - ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ç¸®å° (1.5rem ã‹ã‚‰ 1.25rem ã«ç¸®å°) */
        .final-message {
            padding: 1rem;
            margin-top: 1rem;
            font-size: 1.25rem; 
            font-weight: 700;
            text-align: center;
        }

        /* ãƒã‚¤ãƒŠã‚¹ãƒãƒ¼ã‚¸ãƒ³ã‚’é©ç”¨ã—ã¦ä¸Šéƒ¨ã®éš™é–“ã‚’æœ€å°åŒ– */
        .negative-mt-4 { margin-top: -1rem; } 
        
        /* Tema List specific */
        .theme-item {
            border-left-width: 8px;
            border-left-style: solid;
            border-left-color: #4f46e5;
        }

        .required-label::after {
            content: " *";
            color: #ef4444; /* red-500 */
            margin-left: 0.25rem;
        }
    </style>
</head>
<body class="w-screen h-screen overflow-hidden bg-gray-50 text-gray-800 antialiased p-4 sm:p-8 flex items-start justify-center">

    <div id="game-container" class="w-full h-full mx-auto bg-white p-6 sm:p-10 rounded-3xl shadow-2xl border border-gray-100 flex flex-col space-y-4 max-w-7xl overflow-y-auto">
        
        <div id="control-area" class="flex flex-col items-center justify-center">
            <h1 id="game-title" class="text-3xl sm:text-4xl font-black text-indigo-800 mb-6 text-center">Word Split Challenge</h1>
        </div>
        
        <div id="home-view" class="space-y-6">
            <h2 class="text-xl font-bold text-gray-700">ãƒ†ãƒ¼ãƒé¸æŠ (ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜)</h2>

            <div id="theme-list" class="flex flex-col space-y-3 p-4 bg-gray-50 rounded-xl min-h-40 shadow-inner">
                <p class="text-gray-500 text-center py-10" id="loading-message">ãƒ†ãƒ¼ãƒã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...</p>
            </div>
            
            <div id="question-count-setting" class="p-4 bg-indigo-50 rounded-xl shadow-inner border-t-4 border-indigo-400">
                <label for="question-limit" class="block text-base font-bold text-gray-700">å‡ºé¡Œæ•° (å•é¡Œ)</label>
                <input type="number" id="question-limit" min="5" value="10" class="w-full p-3 border border-gray-300 rounded-lg text-xl focus:ring-indigo-500 focus:border-indigo-500">
                <p id="max-question-info" class="text-sm text-gray-500 mt-1">æœ€å¤§å‡ºé¡Œæ•°: 0 (é¸æŠã—ãŸãƒ†ãƒ¼ãƒã«ä¾å­˜)</p>
            </div>

            <div class="flex flex-col space-y-4">
                <button id="start-selected-theme-button" class="px-6 py-3 bg-green-600 text-white text-lg font-extrabold rounded-xl shadow-md hover:bg-green-700 transition duration-150" disabled>
                    é¸æŠã—ãŸãƒ†ãƒ¼ãƒã§ã‚¹ã‚¿ãƒ¼ãƒˆ
                </button>
                <button id="new-theme-button" class="px-6 py-3 bg-indigo-600 text-white text-lg font-extrabold rounded-xl shadow-md hover:bg-indigo-700 transition duration-150">
                    æ–°ã—ã„ãƒ†ãƒ¼ãƒã‚’ä½œæˆ
                </button>
            </div>
            
             <p class="text-sm text-gray-500 pt-4 text-center">ã“ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ãªãŸã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
        </div>

        <div id="theme-manager-view" class="space-y-6" style="display: none;">
            <h2 id="manager-title" class="text-xl font-bold text-gray-700">æ–°ã—ã„ãƒ†ãƒ¼ãƒã‚’ä½œæˆ</h2>
            
            <div class="space-y-4 p-4 bg-gray-100 rounded-xl shadow-lg">

                <label for="theme-name" class="block text-base font-medium text-gray-700 required-label">ãƒ†ãƒ¼ãƒå</label>
                <input type="text" id="theme-name" class="w-full p-3 border border-gray-300 rounded-lg text-xl focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹: ãƒãƒ­ã‚¦ã‚£ãƒ³å˜èª, å‹•ç‰©ã®åå‰">
                <p id="word-count-info" class="text-sm text-gray-500 text-right">å˜èªæ•°: 0 / æœ€å°5å˜èª</p>
                
                <div class="space-y-4 p-4 bg-purple-50 rounded-xl shadow-lg border-t-4 border-purple-400">
                    <h3 class="text-lg font-bold text-purple-700 flex items-center">
                        ğŸ“‹ ãƒªã‚¹ãƒˆä¸€æ‹¬å–ã‚Šè¾¼ã¿
                    </h3>
                    <p class="text-sm text-gray-600">
                        å¤–éƒ¨ãƒªã‚¹ãƒˆã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ã€ä¸€æ‹¬ã§å˜èªã‚’è¿½åŠ ã§ãã¾ã™ã€‚<br>
                        å½¢å¼: <code>Part1,Part2,æ—¥æœ¬èªè¨³</code> ã¾ãŸã¯ <code>FULLWORD,æ—¥æœ¬èªè¨³</code> (è‡ªå‹•ã§ä¸­å¤®ä»˜è¿‘ã§åˆ†å‰²ã•ã‚Œã¾ã™)
                    </p>
                    <textarea id="import-list-textarea" class="w-full p-3 border border-gray-300 rounded-lg h-32 focus:ring-purple-500 focus:border-purple-500 text-sm" placeholder="ã“ã“ã«ãƒªã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..."></textarea>
                    <button id="import-list-button" class="w-full p-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition duration-150" disabled>
                        ãƒªã‚¹ãƒˆã«å–ã‚Šè¾¼ã¿å®Ÿè¡Œ
                    </button>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-inner space-y-3 border-t-4 border-indigo-400">
                    <h3 class="text-lg font-semibold text-gray-700">å˜èªå€‹åˆ¥è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ </h3>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 required-label">å‰åŠ (Part 1)</label>
                            <input type="text" id="input-part1" class="w-full p-2 border rounded-lg text-base" placeholder="ä¾‹: JACK-O'">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 required-label">å¾ŒåŠ (Part 2)</label>
                            <input type="text" id="input-part2" class="w-full p-2 border rounded-lg text-base" placeholder="ä¾‹: LANTERN">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 required-label">æ—¥æœ¬èªè¨³</label>
                            <input type="text" id="input-translation" class="w-full p-2 border rounded-lg text-base" placeholder="ä¾‹: ã‚¸ãƒ£ãƒƒã‚¯ãƒ»ã‚ªãƒ¼ãƒ»ãƒ©ãƒ³ã‚¿ãƒ³">
                        </div>
                    </div>
                    <button id="add-word-button" class="w-full p-2 bg-purple-500 text-white font-bold rounded-lg hover:bg-purple-600 transition duration-150" disabled>
                        ãƒªã‚¹ãƒˆã«è¿½åŠ 
                    </button>
                </div>
                
                <h3 class="text-lg font-semibold text-gray-700 pt-3">ç¾åœ¨ã®å˜èªãƒªã‚¹ãƒˆ</h3>
                <div id="word-list-editor" class="flex flex-col space-y-2 bg-white p-3 rounded-lg min-h-24 max-h-60 overflow-y-auto">
                    <p class="text-gray-400 text-center py-2">å˜èªãŒã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            </div>

            <div class="flex justify-between space-x-4">
                <button id="back-to-home-button" class="px-6 py-3 bg-gray-500 text-white text-lg font-extrabold rounded-xl shadow-md hover:bg-gray-600 transition duration-150 flex-1">
                    ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
                </button>
                <button id="save-theme-button" class="px-6 py-3 bg-pink-600 text-white text-lg font-extrabold rounded-xl shadow-md hover:bg-pink-700 transition duration-150 flex-1" disabled>
                    ãƒ†ãƒ¼ãƒã‚’ä¿å­˜
                </button>
            </div>
        </div>

        <div id="game-view" style="display: none;">

            <div id="step-1-content" class="negative-mt-4">
                <div id="parts-area" class="puzzle-area flex flex-wrap gap-4 justify-center items-center p-4 bg-gray-50 rounded-xl shadow-inner mb-4">
                    </div>

                <div class="flex flex-col items-center">
                    <div id="target-box" class="flex flex-wrap justify-center">
                        <div class="target-slot w-full md:w-64 h-16 sm:h-20 bg-gray-200 rounded-l-xl border-4 border-dashed border-gray-400 border-r-0 flex items-center justify-center text-3xl sm:text-4xl font-extrabold text-gray-700" data-slot="1">...</div>
                        <div class="target-slot w-full md:w-64 h-16 sm:h-20 bg-gray-200 rounded-r-xl border-4 border-dashed border-gray-400 border-l-0 flex items-center justify-center text-3xl sm:text-4xl font-extrabold text-gray-700" data-slot="2">...</div>
                    </div>
                </div>
                
                <div id="completed-words" style="display: none;">
                </div>
            </div>

            <div id="step-2-section" style="display: none;" class="negative-mt-4">
                
                <div id="game-score-board" class="final-message flex flex-col justify-around items-center p-6 bg-orange-100 rounded-xl shadow-lg mb-8" style="display: none;">
                    <p class="text-xl sm:text-2xl font-semibold text-gray-700 pt-3">æœ€çµ‚ãƒŸã‚¹å›æ•°: <span id="final-miss-display" class="text-3xl sm:text-4xl text-red-600 font-bold">0</span>å›</p>
                </div>
                
                <div id="step2-pair-area" class="flex flex-col md:flex-row gap-4 mb-4">
                    
                    <div id="english-word-container" class="md:w-1/2 flex flex-col space-y-2 p-3 bg-yellow-100 rounded-xl shadow-md">
                        <div id="completed-words-step2" class="puzzle-area flex flex-wrap gap-2 justify-center items-center p-3 bg-yellow-400 rounded-xl shadow-lg">
                            </div>
                    </div>

                    <div id="japanese-translation-container" class="md:w-1/2 flex flex-col space-y-2 p-3 bg-green-100 rounded-xl shadow-md">
                        <div id="translation-area" class="puzzle-area flex flex-wrap gap-2 justify-center items-center p-3 bg-green-500 rounded-xl shadow-lg">
                            </div>
                    </div>
                </div>
                
                <div id="final-pairs-display" class="mt-4 flex flex-col space-y-3">
                    </div>

                <div id="final-score-container" class="mt-8"></div>
            </div>

            <div id="game-button-wrapper" class="flex justify-center pt-6">
                <button id="game-action-button" class="px-12 py-5 bg-indigo-600 text-white text-xl sm:text-2xl font-extrabold rounded-full shadow-xl hover:bg-indigo-700 transition duration-150 w-full max-w-sm">
                    ãƒ›ãƒ¼ãƒ ã¸
                </button>
            </div>
        </div>

    </div>

    <div id="feedback-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-300">
        <div id="feedback-content" class="px-10 py-6 rounded-2xl text-white text-3xl font-black shadow-2xl transform scale-105 transition-transform duration-300">
        </div>
    </div>


    <script>
        // ----------------------------------------------------------------
        // 1. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­å®š
        // ----------------------------------------------------------------
        const LOCAL_STORAGE_KEY = 'word_split_challenge_themes';

        // ----------------------------------------------------------------
        // NEW: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ¼ãƒãƒ‡ãƒ¼ã‚¿ç¾¤ (ä¸­1è‹±å˜èªã‚»ãƒƒãƒˆ & æ­´å²äººç‰©)
        // ----------------------------------------------------------------
        
        // æ—¢å­˜ã®ã€Œä¸­1è‹±å˜èªã‚»ãƒƒãƒˆã€ãƒ†ãƒ¼ãƒ
        const DEFAULT_THEME_DATA_EIGO = {
            id: 'default_chu1_eigo',
            name: 'ä¸­1è‹±å˜èªã‚»ãƒƒãƒˆ',
            createdAt: new Date().toISOString(),
            words: [
                { part1: 'YOUR', part2: 'SELF', translation: 'ã‚ãªãŸè‡ªèº«' },
                { part1: 'FLO', part2: 'WER', translation: 'èŠ±' },
                { part1: 'CHA', part2: 'NCE', translation: 'æ©Ÿä¼š' },
                { part1: 'SCI', part2: 'ENCE', translation: 'ç§‘å­¦' },
                { part1: 'CIT', part2: 'IZEN', translation: 'å¸‚æ°‘' },
                { part1: 'SUP', part2: 'PER', translation: 'å¤•é£Ÿ' },
                { part1: 'FAT', part2: 'HER', translation: 'çˆ¶' },
                { part1: 'BRO', part2: 'THER', translation: 'å…„å¼Ÿ' },
                { part1: 'MYS', part2: 'ELF', translation: 'ç§è‡ªèº«ã‚’' },
                { part1: 'YEST', part2: 'ERDAY', translation: 'æ˜¨æ—¥' },
                { part1: 'LIB', part2: 'RARY', translation: 'å›³æ›¸é¤¨' },
                { part1: 'ARR', part2: 'IVE', translation: 'åˆ°ç€ã™ã‚‹' },
                { part1: 'DECE', part2: 'MBER', translation: 'ï¼‘ï¼’æœˆ' },
                { part1: 'NOTE', part2: 'BOOK', translation: 'ãƒãƒ¼ãƒˆ' },
                { part1: 'Oâ€™C', part2: 'LOCK', translation: 'ï½æ™‚' },
                { part1: 'GUI', part2: 'TAR', translation: 'ã‚®ã‚¿ãƒ¼' },
                { part1: 'PRE', part2: 'SENT', translation: 'ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ' },
                { part1: 'MOR', part2: 'NING', translation: 'æœ' },
                { part1: 'HOME', part2: 'WORK', translation: 'å®¿é¡Œ' },
                { part1: 'MIN', part2: 'UTE', translation: 'åˆ†ï¼Œã¡ã‚‡ã£ã¨ã®é–“' },
                { part1: 'CHU', part2: 'RCH', translation: 'æ•™ä¼š' },
                { part1: 'TOGE', part2: 'THER', translation: 'ä¸€ç·’ã«' },
                { part1: 'LET', part2: 'TER', translation: 'æ‰‹ç´™' },
                { part1: 'SUN', part2: 'DAY', translation: 'æ—¥æ›œæ—¥' },
                { part1: 'THE', part2: 'IRS', translation: 'å½¼(å¥³)ã‚‰ã®ã‚‚ã®' },
                { part1: 'WEDN', part2: 'ESDAY', translation: 'æ°´æ›œæ—¥' },
                { part1: 'BASKE', part2: 'TBALL', translation: 'ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«' },
                { part1: 'COMP', part2: 'UTER', translation: 'ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿' },
                { part1: 'SUB', part2: 'JECT', translation: 'ç§‘ç›®ï¼Œé¡Œç›®' },
                { part1: 'OCT', part2: 'OBER', translation: 'ï¼‘ï¼æœˆ' },
                { part1: 'WEA', part2: 'THER', translation: 'å¤©æ°—' },
                { part1: 'DAN', part2: 'GER', translation: 'å±é™º' },
                { part1: 'PEN', part2: 'CIL', translation: 'é‰›ç­†' },
                { part1: 'JAPA', part2: 'NESE', translation: 'æ—¥æœ¬èª' },
                { part1: 'SOC', part2: 'CER', translation: 'ã‚µãƒƒã‚«ãƒ¼' },
                { part1: 'TEA', part2: 'CHER', translation: 'å…ˆç”Ÿ' },
                { part1: 'ITS', part2: 'ELF', translation: 'ãã‚Œè‡ªèº«' },
                { part1: 'INTER', part2: 'ESTING', translation: 'èˆˆå‘³æ·±ã„' },
                { part1: 'FRI', part2: 'DAY', translation: 'é‡‘æ›œæ—¥' },
                { part1: 'HOSP', part2: 'ITAL', translation: 'ç—…é™¢' },
                { part1: 'AME', part2: 'RICA', translation: 'ã‚¢ãƒ¡ãƒªã‚«åˆè¡†å›½' },
                { part1: 'HUN', part2: 'GRY', translation: 'ç©ºè…¹ã®' },
                { part1: 'NOT', part2: 'HING', translation: 'ä½•ã‚‚ï½ãªã„' },
                { part1: 'BIRT', part2: 'HDAY', translation: 'èª•ç”Ÿæ—¥' },
                { part1: 'SATU', part2: 'RDAY', translation: 'åœŸæ›œæ—¥' },
                { part1: 'FRI', part2: 'END', translation: 'å‹äºº' },
                { part1: 'FEBR', part2: 'UARY', translation: 'ï¼’æœˆ' },
                { part1: 'HIM', part2: 'SELF', translation: 'å½¼è‡ªèº«' },
                { part1: 'BREA', part2: 'KFAST', translation: 'æœé£Ÿ' },
                { part1: 'FAM', part2: 'ILY', translation: 'å®¶æ—' },
                { part1: 'DAUG', part2: 'HTER', translation: 'å¨˜' },
                { part1: 'SIS', part2: 'TER', translation: 'å§‰å¦¹' },
                { part1: 'CAR', part2: 'EFUL', translation: 'æ³¨æ„æ·±ã„' },
                { part1: 'COL', part2: 'LECT', translation: 'é›†ã‚ã‚‹' },
                { part1: 'MON', part2: 'DAY', translation: 'æœˆæ›œæ—¥' },
                { part1: 'SOME', part2: 'TIMES', translation: 'æ™‚ã€…' },
                { part1: 'JAN', part2: 'UARY', translation: 'ï¼‘æœˆ' },
                { part1: 'SEA', part2: 'SON', translation: 'å­£ç¯€' },
                { part1: 'HON', part2: 'EST', translation: 'æ­£ç›´ãª' },
                { part1: 'VIL', part2: 'LAGE', translation: 'æ‘' },
                { part1: 'TEN', part2: 'NIS', translation: 'ãƒ†ãƒ‹ã‚¹' },
                { part1: 'DIN', part2: 'NER', translation: 'å¤•é£Ÿ' },
                { part1: 'TUE', part2: 'SDAY', translation: 'ç«æ›œæ—¥' },
                { part1: 'NOVE', part2: 'MBER', translation: 'ï¼‘ï¼‘æœˆ' },
                { part1: 'SUM', part2: 'MER', translation: 'å¤' },
                { part1: 'NUM', part2: 'BER', translation: 'æ•°' },
                { part1: 'SCH', part2: 'OOL', translation: 'å­¦æ ¡' },
                { part1: 'FAVO', part2: 'RITE', translation: 'ä¸€ç•ªå¥½ããª' },
                { part1: 'ALW', part2: 'AYS', translation: 'ã„ã¤ã‚‚' },
                { part1: 'KIT', part2: 'CHEN', translation: 'å°æ‰€' },
                { part1: 'CAN', part2: 'ADA', translation: 'ã‚«ãƒŠãƒ€' },
                { part1: 'NOB', part2: 'ODY', translation: 'ã ã‚Œã‚‚ï½ãªã„' },
                { part1: 'TOMO', part2: 'RROW', translation: 'æ˜æ—¥' },
                { part1: 'SPR', part2: 'ING', translation: 'æ˜¥' },
                { part1: 'AUSTRA', part2: 'LIA', translation: 'ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢' },
                { part1: 'SOME', part2: 'THING', translation: 'ä½•ã‹' },
                { part1: 'AUG', part2: 'UST', translation: 'ï¼˜æœˆ' },
                { part1: 'ANI', part2: 'MAL', translation: 'å‹•ç‰©' },
                { part1: 'AFTE', part2: 'RNOON', translation: 'åˆå¾Œ' },
                { part1: 'OFF', part2: 'ICE', translation: 'äº‹å‹™æ‰€' },
                { part1: 'MOT', part2: 'HER', translation: 'æ¯' },
                { part1: 'WIN', part2: 'DOW', translation: 'çª“' },
                { part1: 'SLO', part2: 'WLY', translation: 'ã‚†ã£ãã‚Šã¨' },
                { part1: 'LIT', part2: 'TLE', translation: 'å°ã•ã„ï¼Œå¹¼ã„ï¼Œã¡ã‚‡ã£ã¨ã—ãŸ' },
                { part1: 'HER', part2: 'SELF', translation: 'å½¼å¥³è‡ªèº«' },
                { part1: 'WIN', part2: 'TER', translation: 'å†¬' },
                { part1: 'THUR', part2: 'SDAY', translation: 'æœ¨æ›œæ—¥' },
                { part1: 'EVERY', part2: 'THING', translation: 'ã™ã¹ã¦ã®ã‚‚ã®' },
                { part1: 'Oâ€™C', part2: 'LOCK', translation: 'ï½æ™‚' },
                { part1: 'PIC', part2: 'TURE', translation: 'çµµï¼Œå†™çœŸ' },
                { part1: 'FRIE', part2: 'NDLY', translation: 'è¦ªã—ã¿ã‚„ã™ã„' },
                { part1: 'STU', part2: 'DENT', translation: 'å­¦ç”Ÿ' },
                { part1: 'SEPT', part2: 'EMBER', translation: 'ï¼™æœˆ' },
                { part1: 'STA', part2: 'TION', translation: 'é§…' },
                { part1: 'FAM', part2: 'OUS', translation: 'æœ‰åãª' },
                { part1: 'BASE', part2: 'BALL', translation: 'é‡çƒ' },
                { part1: 'DOC', part2: 'TOR', translation: 'åŒ»è€…' },
                { part1: 'ORA', part2: 'NGE', translation: 'ã‚ªãƒ¬ãƒ³ã‚¸' },
                { part1: 'EVERY', part2: 'BODY', translation: 'ã ã‚Œã§ã‚‚ã¿ãª' },
                { part1: 'SOM', part2: 'EONE', translation: 'ã ã‚Œã‹' },
                { part1: 'USU', part2: 'ALLY', translation: 'ãµã¤ã†' },
                { part1: 'RAC', part2: 'KET', translation: 'ãƒ©ã‚±ãƒƒãƒˆ' },
                { part1: 'SEC', part2: 'OND', translation: 'ï¼’æ—¥' },
                { part1: 'ALR', part2: 'EADY', translation: 'ã™ã§ã«' },
                { part1: 'EVERY', part2: 'ONE', translation: 'ã¿ã‚“ãª' },
                { part1: 'GAR', part2: 'DEN', translation: 'åº­' },
                { part1: 'STR', part2: 'ONG', translation: 'å¼·ã„ï¼Œã˜ã‚‡ã†ã¶ãª' },
                { part1: 'EVE', part2: 'NING', translation: 'æ™©' },
                { part1: 'PLA', part2: 'YER', translation: 'é¸æ‰‹ï¼Œæ¼”å¥è€…' },
                { part1: 'PEO', part2: 'PLE', translation: 'äººã€…' },
                { part1: 'BEAU', part2: 'TIFUL', translation: 'ç¾ã—ã„' },
                { part1: 'CAM', part2: 'ERA', translation: 'ã‚«ãƒ¡ãƒ©' },
                { part1: 'POP', part2: 'ULAR', translation: 'äººæ°—ã®ã‚ã‚‹' },
                { part1: 'ENG', part2: 'LISH', translation: 'è‹±èª' },
                { part1: 'THEMSE', part2: 'LVES', translation: 'å½¼(å¥³)ã‚‰è‡ªèº«' },
                { part1: 'COU', part2: 'NTRY', translation: 'å›½ï¼Œã„ãªã‹ï¼Œåœ°æ–¹' },
                { part1: 'PAR', part2: 'ENT', translation: 'è¦ª' },
                { part1: 'OURS', part2: 'ELVES', translation: 'ç§ãŸã¡è‡ªèº«ã‚’' },
                { part1: 'JUN', part2: 'IOR', translation: 'å¹´ä¸‹ã®ï¼Œä¸‹ç´šã®' },
                { part1: 'QUES', part2: 'TION', translation: 'è³ªå•' },
                { part1: 'AUT', part2: 'UMN', translation: 'ç§‹' },
                { part1: 'SIN', part2: 'GER', translation: 'æ­Œæ‰‹' },
            ]
        };

        // æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸã€Œæ­´å²äººç‰©ãƒ»ç”¨èªã€ãƒ†ãƒ¼ãƒ
        const DEFAULT_THEME_DATA_HISTORY = {
            id: 'default_rekishi_jinbutsu',
            name: 'æ­´å²äººç‰©ãƒ»ç”¨èª',
            createdAt: new Date().toISOString(),
            words: [
                // äººç‰©åï¼ˆå…¨è§’æ–‡å­—ï¼‰ã¯ã€ä¸­å¤®ã§è‡ªå‹•åˆ†å‰²ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã«åŸºã¥ã„ã¦Part1/Part2ã«åˆ†å‰²ã—ã¦ã„ã¾ã™ã€‚
                { part1: 'å‘', part2: 'å¼¥å‘¼', translation: 'é‚ªé¦¬å°å›½ã®å¥³ç‹' },
                { part1: 'è–å¾³', part2: 'å¤ªå­', translation: 'å† ä½åäºŒéš' },
                { part1: 'é‘‘', part2: 'çœŸ', translation: 'é£å”ä½¿èˆ¹ã§æ¥æ—¥' },
                { part1: 'å±±ä¸Š', part2: 'æ†¶è‰¯', translation: 'è²§çª®å•ç­”æ­Œ' },
                { part1: 'å‚ä¸Šç”°', part2: 'æ‘éº»å‘‚', translation: 'è¦å¤·ã¨æˆ¦ã£ãŸå¾å¤·å¤§å°†è»' },
                { part1: 'è—¤åŸ', part2: 'é ¼é€š', translation: 'å¹³ç­‰é™¢é³³å‡°å ‚' },
                { part1: 'å¹³', part2: 'å°†é–€', translation: 'æ–°çš‡ã¨åä¹—ã‚Šé–¢æ±ã§åä¹±' },
                { part1: 'æœ€', part2: 'æ¾„', translation: 'æ¯”å¡å±±ãƒ»å»¶æš¦å¯ºãƒ»å¤©å°å®—' },
                { part1: 'ç©º', part2: 'æµ·', translation: 'é«˜é‡å±±ãƒ»é‡‘å‰›å³¯å¯ºãƒ»çœŸè¨€å®—' },
                { part1: 'ç´«', part2: 'å¼éƒ¨', translation: 'æºæ°ç‰©èª' },
                { part1: 'æ¸…å°‘', part2: 'ç´è¨€', translation: 'æ•è‰å­' },
                { part1: 'ç´€', part2: 'è²«ä¹‹', translation: 'å¤ä»Šå’Œæ­Œé›†ã®é¸è€…' },
                { part1: 'å¹³', part2: 'æ¸…ç››', translation: 'å¤ªæ”¿å¤§è‡£ãƒ»æ­¦å£«ã§æ”¿æ²»ã®å®Ÿæ¨©' },
                { part1: 'æº', part2: 'é ¼æœ', translation: 'å¾å¤·å¤§å°†è»ãƒ»éŒå€‰å¹•åºœã‚’é–‹ã„ãŸ' },
                { part1: 'å¾Œé³¥', part2: 'ç¾½ä¸Šçš‡', translation: 'æ‰¿ä¹…ã®ä¹±ã§æ•—ã‚Œã€éš å²ã«æµã•ã‚ŒãŸ' },
                { part1: 'åŒ—æ¡', part2: 'æ³°æ™‚', translation: 'å¾¡æˆæ•—å¼ç›®' },
                { part1: 'å¾Œé†', part2: 'é†å¤©çš‡', translation: 'å»ºæ­¦ã®æ–°æ”¿' },
                { part1: 'è¶³åˆ©', part2: 'å°Šæ°', translation: 'å¾å¤·å¤§å°†è»ãƒ»äº¬éƒ½ã«å¹•åºœã‚’é–‹ã„ãŸ' },
                { part1: 'è¶³åˆ©', part2: 'ç¾©æº€', translation: 'é‡‘é–£å¯ºã‚’å»ºã¦ãŸ' },
                { part1: 'è¶³åˆ©', part2: 'ç¾©æ”¿', translation: 'éŠ€é–£å¯ºã‚’å»ºã¦ãŸ' },
                { part1: 'å°š', part2: 'æ°', translation: 'ç‰çƒç‹å›½' },
                { part1: 'æ³•', part2: 'ç„¶', translation: 'æµ„åœŸå®—' },
                { part1: 'è¦ª', part2: 'é¸', translation: 'æµ„åœŸçœŸå®—' },
                { part1: 'å‰ç”°', part2: 'å…¼å¥½', translation: 'å¾’ç„¶è‰' },
                { part1: 'é›ª', part2: 'èˆŸ', translation: 'æ°´å¢¨ç”»' },
                { part1: 'ãƒ•ãƒ©ãƒ³ã‚·ã‚³', part2: 'ãƒ»ã‚¶ãƒ“ã‚¨ãƒ«', translation: 'ã‚­ãƒªã‚¹ãƒˆæ•™ãƒ»å®£æ•™å¸«' },
                { part1: 'ç¹”ç”°', part2: 'ä¿¡é•·', translation: 'æ¡¶ç‹­é–“ã®æˆ¦ã„ãƒ»ä»Šå·ç¾©å…ƒã‚’ç ´ã£ãŸ' },
                { part1: 'è±Šè‡£', part2: 'ç§€å‰', translation: '1590å¹´ã«å…¨å›½ã‚’çµ±ä¸€' },
                { part1: 'åƒ', part2: 'åˆ©ä¼‘', translation: 'èŒ¶ã®æ¹¯' },
                { part1: 'å¾³å·', part2: 'å®¶åº·', translation: 'æ±Ÿæˆ¸å¹•åºœã‚’é–‹ã„ãŸ' },
                { part1: 'å¾³å·', part2: 'å®¶å…‰', translation: 'å‚å‹¤äº¤ä»£' },
                { part1: 'å¾³å·', part2: 'ç¶±å‰', translation: 'ç”Ÿé¡æ†ã¿ã®ä»¤' },
                { part1: 'å¾³å·', part2: 'å‰å®—', translation: 'äº«ä¿ã®æ”¹é©' },
                { part1: 'æ¾å¹³', part2: 'å®šä¿¡', translation: 'å¯›æ”¿ã®æ”¹é©' },
                { part1: 'æ°´é‡', part2: 'å¿ é‚¦', translation: 'å¤©ä¿ã®æ”¹é©' },
                { part1: 'äº•åŸ', part2: 'è¥¿é¶´', translation: 'æµ®ä¸–è‰å­ã€Œå¥½è‰²ä¸€ä»£ç”·ã€' },
                { part1: 'è¿‘æ¾é–€', part2: 'å·¦è¡›é–€', translation: 'äººå½¢æµ„ç‘ ç’ƒã€Œæ›½æ ¹å´å¿ƒä¸­ã€' },
                { part1: 'æ­Œå·', part2: 'åºƒé‡', translation: 'æµ®ä¸–çµµã€Œæ±æµ·é“äº”åä¸‰æ¬¡ã€' },
                { part1: 'è‘›é£¾', part2: 'åŒ—æ–', translation: 'é¢¨æ™¯ç”»ã€Œå¯Œå¶½ä¸‰åå…­æ™¯ã€' },
                { part1: 'æ¾å°¾', part2: 'èŠ­è•‰', translation: 'ç´€è¡Œæ–‡ã€ŒãŠãã®ã»ãé“ã€' },
                { part1: 'æœ¬å±…', part2: 'å®£é•·', translation: 'å¤äº‹è¨˜ä¼' },
                { part1: 'ä¼Šèƒ½', part2: 'å¿ æ•¬', translation: 'å…¨å›½ã‚’æ¸¬é‡' },
                { part1: 'ãƒš', part2: 'ãƒªãƒ¼', translation: 'æµ¦è³€æ²–ã«æ¥èˆªãƒ»é–‹å›½ã‚’ã›ã¾ã£ãŸ' },
                { part1: 'äº•ä¼Š', part2: 'ç›´å¼¼', translation: 'æ—¥ç±³ä¿®å¥½é€šå•†æ¡ç´„ã‚’ç· çµ' },
                { part1: 'å¾³å·', part2: 'æ…¶å–œ', translation: 'å¤§æ”¿å¥‰é‚„' },
                { part1: 'ç¦æ²¢', part2: 'è«­å‰', translation: 'ã€Œå­¦å•ã®ã™ã™ã‚ã€' },
                { part1: 'è¥¿éƒ·', part2: 'éš†ç››', translation: 'å¾éŸ“è«–ã§æ”¿åºœã‚’å»ã‚Šã€é¹¿å…å³¶ã§æŒ™å…µ' },
                { part1: 'ä¼Šè—¤', part2: 'åšæ–‡', translation: 'åˆä»£ã®å†…é–£ç·ç†å¤§è‡£' },
                { part1: 'å°æ‘', part2: 'å¯¿å¤ªéƒ', translation: 'é–¢ç¨è‡ªä¸»æ¨©ã®å›å¾©' },
                { part1: 'ç”°ä¸­', part2: 'æ­£é€ ', translation: 'è¶³å°¾é‰±æ¯’äº‹ä»¶' },
            ]
        };

        // å…¨ã¦ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ¼ãƒã‚’æ ¼ç´ã™ã‚‹é…åˆ—
        const ALL_DEFAULT_THEMES = [
            DEFAULT_THEME_DATA_EIGO,
            DEFAULT_THEME_DATA_HISTORY 
        ];


        // ----------------------------------------------------------------
        // 2. DOMè¦ç´ ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
        // ----------------------------------------------------------------
        
        // UI Views
        const homeView = document.getElementById('home-view');
        const themeManagerView = document.getElementById('theme-manager-view');
        const gameView = document.getElementById('game-view');
        const managerTitle = document.getElementById('manager-title');
        const gameTitle = document.getElementById('game-title'); 

        // Home Elements
        const themeList = document.getElementById('theme-list');
        const startSelectedThemeButton = document.getElementById('start-selected-theme-button');
        const newThemeButton = document.getElementById('new-theme-button');
        const loadingMessage = document.getElementById('loading-message'); 
        // Question Limit Elements
        const questionLimitInput = document.getElementById('question-limit');
        const maxQuestionInfo = document.getElementById('max-question-info');

        // Manager Elements
        const themeNameInput = document.getElementById('theme-name');
        const inputPart1 = document.getElementById('input-part1');
        const inputPart2 = document.getElementById('input-part2');
        const inputTranslation = document.getElementById('input-translation');
        const addWordButton = document.getElementById('add-word-button');
        const wordListEditor = document.getElementById('word-list-editor');
        const saveThemeButton = document.getElementById('save-theme-button');
        const backToHomeButton = document.getElementById('back-to-home-button');
        const wordCountInfo = document.getElementById('word-count-info');
        
        // Import Elements
        const importListTextarea = document.getElementById('import-list-textarea');
        const importListButton = document.getElementById('import-list-button');


        // Game Elements (æ—¢å­˜)
        const partsArea = document.getElementById('parts-area');
        const targetSlots = document.querySelectorAll('.target-slot');
        const completedWordsAreaStep1 = document.getElementById('completed-words');
        const completedWordsAreaStep2 = document.getElementById('completed-words-step2'); 
        const translationArea = document.getElementById('translation-area');
        const gameActionButton = document.getElementById('game-action-button');
        const gameButtonWrapper = document.getElementById('game-button-wrapper'); 
        const gameScoreBoard = document.getElementById('game-score-board');
        const finalMissDisplay = document.getElementById('final-miss-display');
        const step1Content = document.getElementById('step-1-content');
        const step2Section = document.getElementById('step-2-section');
        const finalPairsDisplay = document.getElementById('final-pairs-display');
        const step2PairArea = document.getElementById('step2-pair-area'); 
        const finalScoreContainer = document.getElementById('final-score-container'); 

        // Feedback
        const feedbackOverlay = document.getElementById('feedback-overlay');
        const feedbackContent = document.getElementById('feedback-content');


        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
        let currentView = 'home';
        let allThemes = []; 
        let selectedTheme = null; 
        let editingTheme = { id: null, name: '', words: [] }; 
        let questionLimit = 10; 
        
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let gameWordData = []; 
        let misses = 0; 
        let completedCount = 0; 
        let step2MatchCount = 0; 
        let isGameActive = false;
        let isChecking = false; 
        let slottedParts = [null, null]; 


        // ----------------------------------------------------------------
        // 3. UI/View åˆ¶å¾¡ & ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        // ----------------------------------------------------------------

        function setView(view) {
            currentView = view;
            homeView.style.display = 'none';
            themeManagerView.style.display = 'none';
            gameView.style.display = 'none';
            
            // Req 1: ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤ºã®åˆ¶å¾¡
            if (view === 'game') {
                gameTitle.style.display = 'none';
            } else {
                gameTitle.style.display = 'block';
            }

            if (view === 'home') {
                homeView.style.display = 'block';
                selectedTheme = null;
                startSelectedThemeButton.disabled = true;
                loadThemes(); 
            } else if (view === 'manager') {
                themeManagerView.style.display = 'block';
                // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
                importListTextarea.value = ''; 
                importListButton.disabled = true;
                updateManagerUI();
            } else if (view === 'game') {
                gameView.style.display = 'block';
            }
        }
        
        function logFeedback(text, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${text}`);
        }
        
        function showFeedback(message, type) {
            feedbackContent.className = 'px-10 py-6 rounded-2xl text-white text-6xl font-black shadow-2xl transform scale-105 transition-transform duration-300';
            
            if (type === 'success') {
                feedbackContent.textContent = 'âœ… ' + message;
                feedbackContent.classList.add('bg-green-600');
            } else if (type === 'error') {
                feedbackContent.textContent = 'âŒ ' + message;
                feedbackContent.classList.add('bg-red-600');
            }
            
            feedbackOverlay.classList.remove('opacity-0', 'pointer-events-none');
            
            setTimeout(() => {
                feedbackOverlay.classList.add('opacity-0', 'pointer-events-none');
            }, 1500);
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }


        // ----------------------------------------------------------------
        // 4. ãƒ†ãƒ¼ãƒã®æ°¸ç¶šåŒ– (localStorage)
        // ----------------------------------------------------------------

        function generateUniqueId() {
            return 'theme_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function saveThemesToLocal() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allThemes));
                logFeedback('Themes successfully saved to localStorage.', 'local');
            } catch (e) {
                logFeedback(`Error saving to localStorage: ${e.message}`, 'error');
                showFeedback('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
            }
        }

        function loadThemes() {
            loadingMessage.style.display = 'block';
            loadingMessage.textContent = 'ãƒ†ãƒ¼ãƒã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...';
            
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                allThemes = data ? JSON.parse(data) : [];
                
                let shouldSave = false;

                // NEW: Default Theme Check and Initialization (è¤‡æ•°ã®ãƒ†ãƒ¼ãƒã«å¯¾å¿œ)
                ALL_DEFAULT_THEMES.forEach(defaultTheme => {
                    const defaultThemeExists = allThemes.some(t => t.id === defaultTheme.id);
                    
                    if (!defaultThemeExists) {
                        // Add the default theme to the start of the list
                        allThemes.unshift(defaultTheme); 
                        shouldSave = true;
                        logFeedback(`Default theme "${defaultTheme.name}" added.`, 'local');
                    }
                });
                
                if (shouldSave) {
                    // æœ€æ–°ã®çŠ¶æ…‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ¼ãƒã‚’å«ã‚€ï¼‰ã‚’ä¿å­˜
                    saveThemesToLocal(); 
                }
                
                logFeedback(`Loaded ${allThemes.length} themes (total) from localStorage.`, 'local');
            } catch (e) {
                logFeedback(`Error loading from localStorage: ${e.message}`, 'error');
                allThemes = [...ALL_DEFAULT_THEMES]; // Fallback to only the default themes
                saveThemesToLocal(); 
                showFeedback('ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ¼ãƒã§é–‹å§‹ã—ã¾ã™ã€‚', 'error');
            }
            
            loadingMessage.style.display = 'none';
            updateThemeListUI();
        }
        
        function saveTheme(theme) {
            if (!theme.id) {
                theme.id = generateUniqueId();
                theme.createdAt = new Date().toISOString();
                allThemes.push(theme);
                showFeedback('æ–°ã—ã„ãƒ†ãƒ¼ãƒã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
            } 
            else {
                const index = allThemes.findIndex(t => t.id === theme.id);
                if (index !== -1) {
                    theme.updatedAt = new Date().toISOString();
                    allThemes[index] = theme;
                    showFeedback('ãƒ†ãƒ¼ãƒã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                } else {
                    showFeedback('ãƒ†ãƒ¼ãƒã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
                    return;
                }
            }
            
            saveThemesToLocal(); 
            setView('home'); 
        }

        function deleteTheme(themeId) {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ¼ãƒã®å‰Šé™¤ã¯è¨±å¯ã—ãªã„
            if (ALL_DEFAULT_THEMES.some(t => t.id === themeId)) {
                showFeedback('ã“ã®ãƒ†ãƒ¼ãƒã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚', 'error');
                return;
            }

            const initialLength = allThemes.length;
            allThemes = allThemes.filter(t => t.id !== themeId);
            
            if (allThemes.length < initialLength) {
                saveThemesToLocal(); 
                showFeedback('ãƒ†ãƒ¼ãƒã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            } else {
                 showFeedback('ãƒ†ãƒ¼ãƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'error');
            }
            updateThemeListUI(); 
        }

        // ----------------------------------------------------------------
        // 5. Theme Manager UI åˆ¶å¾¡
        // ----------------------------------------------------------------
        
        function setupNewTheme() {
            editingTheme = { id: null, name: '', words: [] };
            managerTitle.textContent = 'æ–°ã—ã„ãƒ†ãƒ¼ãƒã‚’ä½œæˆ';
            themeNameInput.value = '';
            inputPart1.value = '';
            inputPart2.value = '';
            inputTranslation.value = '';
            importListTextarea.value = ''; 
            updateManagerUI();
        }

        function editExistingTheme(theme) {
            editingTheme = JSON.parse(JSON.stringify(theme)); 
            managerTitle.textContent = `ãƒ†ãƒ¼ãƒã‚’ç·¨é›†: ${theme.name}`;
            themeNameInput.value = theme.name;
            importListTextarea.value = ''; 
            updateManagerUI();
            setView('manager');
        }

        function updateManagerUI() {
            wordListEditor.innerHTML = '';
            if (editingTheme.words.length === 0) {
                wordListEditor.innerHTML = '<p class="text-gray-400 text-center py-2">å˜èªãŒã‚ã‚Šã¾ã›ã‚“</p>';
            } else {
                editingTheme.words.forEach((word, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-2 bg-indigo-50 rounded-lg';
                    div.innerHTML = `
                        <span class="text-sm font-medium text-gray-700">${word.part1} | ${word.part2} = ${word.translation}</span>
                        <button data-index="${index}" class="remove-word-btn text-red-500 hover:text-red-700 font-bold px-2">å‰Šé™¤</button>
                    `;
                    wordListEditor.appendChild(div);
                });
                wordListEditor.querySelectorAll('.remove-word-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => removeWordFromTheme(parseInt(e.target.dataset.index)));
                });
            }
            
            wordCountInfo.textContent = `å˜èªæ•°: ${editingTheme.words.length} / æœ€å°5å˜èª`;

            const isValid = themeNameInput.value.trim() !== '' && editingTheme.words.length >= 5;
            saveThemeButton.disabled = !isValid;
        }
        
        // å˜èªå€‹åˆ¥è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã®åˆ¶å¾¡
        [themeNameInput, inputPart1, inputPart2, inputTranslation].forEach(input => {
            input.addEventListener('input', () => {
                const part1 = inputPart1.value.trim();
                const part2 = inputPart2.value.trim();
                const trans = inputTranslation.value.trim();
                addWordButton.disabled = !(part1 && part2 && trans);
                
                editingTheme.name = themeNameInput.value.trim();
                updateManagerUI(); 
            });
        });

        function addWordToTheme() {
            const part1 = inputPart1.value.trim().toUpperCase();
            const part2 = inputPart2.value.trim().toUpperCase();
            const translation = inputTranslation.value.trim();
            
            if (part1 && part2 && translation) {
                editingTheme.words.push({ part1, part2, translation });
                
                inputPart1.value = '';
                inputPart2.value = '';
                inputTranslation.value = '';
                addWordButton.disabled = true;
                
                updateManagerUI();
            }
        }
        
        function removeWordFromTheme(index) {
            editingTheme.words.splice(index, 1);
            updateManagerUI();
        }
        
        // ãƒªã‚¹ãƒˆä¸€æ‹¬å–ã‚Šè¾¼ã¿æ©Ÿèƒ½ (è‡ªå‹•åˆ†å‰²ãƒ­ã‚¸ãƒƒã‚¯è¾¼ã¿)
        importListTextarea.addEventListener('input', () => {
            importListButton.disabled = importListTextarea.value.trim() === '';
        });

        function handleImportList() {
            const rawText = importListTextarea.value.trim();
            if (!rawText) return;
            
            const lines = rawText.split('\n').filter(line => line.trim() !== '');
            let importedCount = 0;
            let failedCount = 0;

            lines.forEach(line => {
                const parts = line.split(',').map(p => p.trim());
                
                let part1 = '';
                let part2 = '';
                let translation = '';
                let isValidEntry = false;

                // 1. æ—¢å­˜ã®ã€Œ3é …ç›®: Part1, Part2, æ—¥æœ¬èªè¨³ã€å½¢å¼ã®ãƒã‚§ãƒƒã‚¯
                if (parts.length === 3) {
                    [part1, part2, translation] = parts;
                    if (part1 && part2 && translation) {
                        isValidEntry = true;
                    }
                } 
                // 2. ã€Œ2é …ç›®: ENGLISHWORD, æ—¥æœ¬èªè¨³ã€å½¢å¼ã®ãƒã‚§ãƒƒã‚¯ã¨è‡ªå‹•åˆ†å‰²ãƒ­ã‚¸ãƒƒã‚¯
                else if (parts.length === 2) {
                    const [fullWord, trans] = parts;
                    
                    if (fullWord && trans) {
                        // æ–‡å­—åˆ—ã‚’å¤§æ–‡å­—åŒ–ã›ãšã€ãã®ã¾ã¾ã®æ–‡å­—æ•°ã§å‡¦ç†
                        const word = fullWord.trim();
                        const len = word.length;
                        
                        // å˜èªã®é•·ã•ã‚’åŸºã«ä¸­å¤®ã§åˆ†å‰²ã™ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨ˆç®— (åˆ‡ã‚Šä¸‹ã’)
                        const splitIndex = Math.floor(len / 2); 
                        
                        part1 = word.substring(0, splitIndex);
                        part2 = word.substring(splitIndex);
                        translation = trans;
                        
                        // åˆ†å‰²å¾Œã®Part1, Part2ãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª
                        if (part1 && part2) {
                             isValidEntry = true;
                        }
                    }
                } 

                if (isValidEntry) {
                    editingTheme.words.push({
                        // Part1, Part2ã¯toUpperCase()ã›ãšã«ã€å…ƒã®æ–‡å­—åˆ—ã®å½¢å¼ã‚’ç¶­æŒ
                        part1: part1, 
                        part2: part2,
                        translation: translation
                    });
                    importedCount++;
                } else {
                    failedCount++;
                }
            });

            importListTextarea.value = '';
            importListButton.disabled = true;
            updateManagerUI();

            if (importedCount > 0) {
                showFeedback(`${importedCount}å€‹ã®å˜èªã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸ`, 'success');
            }
            if (failedCount > 0) {
                logFeedback(`${failedCount}è¡Œã¯ç„¡åŠ¹ãªå½¢å¼ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸã€‚`, 'error');
            }
        }


        // ----------------------------------------------------------------
        // 6. Home UI åˆ¶å¾¡
        // ----------------------------------------------------------------

        function updateThemeListUI() {
            themeList.innerHTML = ''; 
            
            if (allThemes.length === 0) {
                themeList.innerHTML = '<p class="text-gray-500 text-center py-4">ä¿å­˜ã•ã‚ŒãŸãƒ†ãƒ¼ãƒã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                startSelectedThemeButton.disabled = true;
            }

            allThemes.forEach(theme => {
                const div = document.createElement('div');
                div.className = 'theme-item p-3 bg-white rounded-xl shadow-md text-lg flex justify-between items-center';
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ¼ãƒã®èƒŒæ™¯è‰²ã‚’å¤‰æ›´
                if (theme.id === DEFAULT_THEME_DATA_EIGO.id) {
                    div.style.backgroundColor = '#ecfdf5'; // Green-50 for English
                } else if (theme.id === DEFAULT_THEME_DATA_HISTORY.id) {
                    div.style.backgroundColor = '#fef3c7'; // Yellow-100 for History
                }
                
                if (theme.words.length < 5) {
                    div.classList.add('opacity-50', 'bg-gray-200');
                    div.title = "5å˜èªæœªæº€ã®ãŸã‚ã€ã‚²ãƒ¼ãƒ é–‹å§‹ã¯ã§ãã¾ã›ã‚“ã€‚";
                }

                div.dataset.id = theme.id;
                
                const themeNameSpan = document.createElement('span');
                themeNameSpan.textContent = `${theme.name} (${theme.words.length}å˜èª)`;
                themeNameSpan.classList.add('flex-grow', 'font-bold', 'hover:text-indigo-600', 'cursor-pointer');
                themeNameSpan.addEventListener('click', () => handleThemeSelect(theme));

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flex space-x-2 ml-4';

                const editBtn = document.createElement('button');
                editBtn.textContent = 'ç·¨é›†';
                editBtn.className = 'text-sm px-3 py-1 bg-yellow-400 rounded hover:bg-yellow-500';
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // ãƒ†ãƒ¼ãƒé¸æŠã¨ãƒãƒƒãƒ†ã‚£ãƒ³ã‚°ã—ãªã„ã‚ˆã†ã«
                    editExistingTheme(theme);
                });
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ¼ãƒã¯å‰Šé™¤ä¸å¯
                if (!ALL_DEFAULT_THEMES.some(t => t.id === theme.id)) { 
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'å‰Šé™¤';
                    deleteBtn.className = 'text-sm px-3 py-1 bg-red-400 text-white rounded hover:bg-red-500';
                    deleteBtn.addEventListener('click', (e) => { 
                        e.stopPropagation();
                        if(window.confirm(`ã€Œ${theme.name}ã€ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                            deleteTheme(theme.id);
                        }
                    });
                    actionsDiv.appendChild(deleteBtn);
                }
                
                actionsDiv.appendChild(editBtn);
                
                div.appendChild(themeNameSpan);
                div.appendChild(actionsDiv);
                
                themeList.appendChild(div);
            });
            
            if (selectedTheme) {
                const selectedElement = document.querySelector(`.theme-item[data-id="${selectedTheme.id}"]`);
                if (selectedElement) {
                    selectedElement.classList.add('selected');
                }
                
                // Max Question Info Update
                const maxWords = selectedTheme.words.length;
                
                // æœ€å°å€¤ã¨æœ€å¤§å€¤ã‚’è¨­å®š
                questionLimitInput.min = 5;
                questionLimitInput.max = maxWords;

                // questionLimitã‚’æ›´æ–°ã—ã€UIã«åæ˜ 
                let currentLimit = parseInt(questionLimitInput.value);
                if (isNaN(currentLimit) || currentLimit < 5) currentLimit = 5;
                questionLimit = Math.min(currentLimit, maxWords);
                questionLimitInput.value = questionLimit;
                
                maxQuestionInfo.textContent = `æœ€å¤§å‡ºé¡Œæ•°: ${maxWords} (ç¾åœ¨ã®è¨­å®š: ${questionLimit}å•)`;

            } else {
                // Reset info if no theme is selected
                maxQuestionInfo.textContent = `æœ€å¤§å‡ºé¡Œæ•°: 0 (é¸æŠã—ãŸãƒ†ãƒ¼ãƒã«ä¾å­˜)`;
                questionLimitInput.min = 5;
                questionLimitInput.max = 5; // Default minimal max
                questionLimitInput.value = 5; 
            }

            startSelectedThemeButton.disabled = !selectedTheme || selectedTheme.words.length < 5;
        }
        
        function handleThemeSelect(theme) {
            document.querySelectorAll('.theme-item').forEach(item => item.classList.remove('selected'));

            if (theme.words.length < 5) {
                showFeedback('ã‚²ãƒ¼ãƒ é–‹å§‹ã«ã¯5å˜èªä»¥ä¸ŠãŒå¿…è¦ã§ã™ã€‚', 'error');
                selectedTheme = null;
                startSelectedThemeButton.disabled = true;
                return;
            }

            if (selectedTheme && selectedTheme.id === theme.id) {
                selectedTheme = null;
                startSelectedThemeButton.disabled = true;
            } else {
                selectedTheme = theme;
                document.querySelector(`.theme-item[data-id="${theme.id}"]`).classList.add('selected');
                startSelectedThemeButton.disabled = false;
                
                // Set initial question limit based on selected theme
                const maxWords = selectedTheme.words.length;
                questionLimit = Math.min(questionLimitInput.value || 10, maxWords);
                questionLimitInput.value = questionLimit;
            }
            
            updateThemeListUI(); // Call this to update the max limit info
        }
        
        // Event Listener for question limit change
        questionLimitInput.addEventListener('input', () => {
            let value = parseInt(questionLimitInput.value);
            const min = parseInt(questionLimitInput.min);
            const max = parseInt(questionLimitInput.max);

            if (isNaN(value) || value < min) {
                value = min;
            } else if (value > max) {
                value = max;
            }
            
            questionLimitInput.value = value;
            questionLimit = value;

            if (selectedTheme) {
                 maxQuestionInfo.textContent = `æœ€å¤§å‡ºé¡Œæ•°: ${selectedTheme.words.length} (ç¾åœ¨ã®è¨­å®š: ${questionLimit}å•)`;
            }
        });


        // ----------------------------------------------------------------
        // 7. ã‚²ãƒ¼ãƒ åˆ¶å¾¡
        // ----------------------------------------------------------------

        function startGame() {
            if (!selectedTheme || selectedTheme.words.length < 5) {
                showFeedback('ãƒ†ãƒ¼ãƒã‚’é¸æŠã™ã‚‹ã‹ã€5å˜èªä»¥ä¸Šã‚ã‚‹ãƒ†ãƒ¼ãƒã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚', 'error');
                setView('home');
                return;
            }
            
            const limit = parseInt(questionLimitInput.value) || 5; 
            const availableWords = selectedTheme.words;
            
            let wordsForGame;
            if (limit >= availableWords.length) {
                wordsForGame = availableWords;
            } else {
                const shuffledWords = shuffle([...availableWords]); 
                wordsForGame = shuffledWords.slice(0, limit);
            }
            
            // Map the selected words to game data structure
            gameWordData = wordsForGame.map((word, index) => ({
                part1: word.part1,
                part2: word.part2,
                full: `${word.part1}${word.part2}`, 
                translation: word.translation,
                // IDã¯Step 2ã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã€ã“ã“ã§ä¸€æ„ã«è¨­å®š
                id: index + 1 
            }));

            misses = 0;
            completedCount = 0;
            step2MatchCount = 0;
            isGameActive = true;

            gameButtonWrapper.style.display = 'none';

            gameScoreBoard.style.display = 'none'; 
            finalScoreContainer.innerHTML = ''; 
            step2Section.style.display = 'none';

            setView('game');
            initializeStep1();
            logFeedback(`ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼å‡ºé¡Œæ•°: ${gameWordData.length}å•`, 'info');
        }

        function finalResult() {
            isGameActive = false;
            
            gameButtonWrapper.style.display = 'flex';
            
            const finalScoreHTML = `
                <div class="final-message flex justify-center items-center p-4 bg-orange-100 rounded-xl shadow-lg mt-8">
                    <p class="text-3xl font-semibold text-gray-700">æœ€çµ‚ãƒŸã‚¹å›æ•°: <span class="text-5xl text-red-600 font-bold">${misses}</span>å›</p>
                </div>
            `;
            
            finalScoreContainer.innerHTML = finalScoreHTML;

            step1Content.style.display = 'none';
            step2PairArea.style.display = 'none'; 
            step2Section.style.display = 'block'; 
            
            logFeedback(`ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼ãƒŸã‚¹ã®å›æ•°: ${misses}å›`, 'final');
            
            gameActionButton.textContent = 'ãƒ›ãƒ¼ãƒ ã¸';
        }

        function getPartRole(text) {
            // æ–‡å­—åˆ—ã«ã‚ˆã‚‹åˆ¤å®š: Part 1 ã¾ãŸã¯ Part 2 ã®ã©ã¡ã‚‰ã«ä½¿ã‚ã‚Œã‚‹å˜èªã‹ã‚’ç‰¹å®šã™ã‚‹
            for (const data of gameWordData) {
                if (data.part1 === text) return 1; 
                if (data.part2 === text) return 2; 
            }
            return 0; // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ (æœ¬æ¥ã¯ç™ºç”Ÿã—ãªã„ã¯ãš)
        }

        function initializeStep1() {
            partsArea.innerHTML = ''; 
            completedWordsAreaStep1.innerHTML = '';
            step1Content.style.display = 'block';
            
            let allParts = [];
            
            // å˜èªãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ‘ãƒ¼ãƒ„ã‚’ç”Ÿæˆ
            gameWordData.forEach(data => {
                // ã“ã“ã§IDã§ã¯ãªãã€å˜èªãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™ã“ã¨ã§ã€getPartRoleã®åˆ¤å®šãŒå³å¯†ã«ãªã‚‹
                allParts.push({ text: data.part1, id: data.id, role: getPartRole(data.part1) });
                allParts.push({ text: data.part2, id: data.id, role: getPartRole(data.part2) });
            });

            shuffle(allParts).forEach(part => {
                const div = document.createElement('div');
                div.className = 'word-part px-4 py-3 bg-orange-500 text-white font-extrabold rounded-xl hover:bg-orange-600 text-5xl sm:text-6xl shadow-xl border-4 border-transparent';
                div.textContent = part.text;
                // æ³¨æ„: ã“ã“ã§ã‚»ãƒƒãƒˆã•ã‚Œã‚‹IDã¯ã€Step 1ã®çµåˆãƒã‚§ãƒƒã‚¯ã«ã¯ä½¿ç”¨ã›ãšã€Step 2ã®æ—¥æœ¬èªè¨³ãƒã‚§ãƒƒã‚¯ã«ã®ã¿ä½¿ç”¨
                div.dataset.id = part.id; 
                div.dataset.role = part.role; 
                div.addEventListener('click', handlePartClick);
                partsArea.appendChild(div);
            });
            
            slottedParts = [null, null]; 
            updateVisualSlots();
        }
        
        function handlePartClick(event) {
            if (!isGameActive || isChecking || completedCount === gameWordData.length) return;
            
            const partElement = event.target;
            const partRole = parseInt(partElement.dataset.role); 
            
            if (partRole === 0) return; // ä¸æ­£ãªãƒ‘ãƒ¼ãƒ„ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢

            const partData = {
                text: partElement.textContent,
                id: parseInt(partElement.dataset.id), // Step 2ã§ä½¿ç”¨
                element: partElement,
                role: partRole
            };
            
            const slotIndex = partRole - 1; 
            
            // æ—¢ã«ãƒ”ãƒ¼ã‚¹ãŒã‚¹ãƒ­ãƒƒãƒˆã«ã‚ã‚Šã€ãã‚Œã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆ (é¸æŠè§£é™¤)
            if (slottedParts[slotIndex] && slottedParts[slotIndex].element === partElement) {
                slottedParts[slotIndex] = null;
                partsArea.appendChild(partElement);
            } 
            // ã‚¹ãƒ­ãƒƒãƒˆãŒç©ºã§ã€ãƒ”ãƒ¼ã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆ (é…ç½®)
            else if (!slottedParts[slotIndex]) {
                slottedParts[slotIndex] = partData;
                partElement.remove();
            }
            // ã‚¹ãƒ­ãƒƒãƒˆãŒåŸ‹ã¾ã£ã¦ã„ã‚‹çŠ¶æ…‹ã§ã€åˆ¥ã®ãƒ”ãƒ¼ã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆ (ç«¶åˆ/ãƒŸã‚¹ç™ºç”Ÿ)
            else {
                // **ç«¶åˆæ™‚ã¯ãƒŸã‚¹ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆã—ãªã„ (UXå‘ä¸Š)**

                // æ—¢ã«ã‚¹ãƒ­ãƒƒãƒˆã«å…¥ã£ã¦ã„ã‚‹ãƒ‘ãƒ¼ãƒ„ã‚’ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã«æˆ»ã™
                const existingPartElement = slottedParts[slotIndex].element;
                partsArea.appendChild(existingPartElement);
                existingPartElement.classList.remove('selected');
                
                // ã‚¹ãƒ­ãƒƒãƒˆã«æ–°ã—ã„ãƒ‘ãƒ¼ãƒ„ã‚’é…ç½®
                slottedParts[slotIndex] = partData;
                partElement.remove();

                // UIã‚’æ›´æ–°
                updateVisualSlots();
                
                // æ–°ã—ã„ãƒ”ãƒ¼ã‚¹ãŒé…ç½®ã•ã‚ŒãŸãŸã‚ã€çµåˆãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†
                if (slottedParts[0] && slottedParts[1]) {
                    checkCombination();
                }

                return; 
            }
            
            updateVisualSlots();

            if (slottedParts[0] && slottedParts[1]) {
                checkCombination();
            }
        }
        
        function updateVisualSlots() {
            targetSlots.forEach((slot, index) => {
                const part = slottedParts[index];
                
                // ã‚¹ãƒ­ãƒƒãƒˆå†…ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å¯„ã›ã‚’å¤‰æ›´ (Flexboxã®justify-*ã‚’ä½¿ç”¨)
                slot.classList.remove('justify-center', 'justify-start', 'justify-end'); 

                // æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢
                slot.innerHTML = ''; 

                if (part) {
                    // Part 1 (index 0) ã¯å³å¯„ã› (justify-end)ã€Part 2 (index 1) ã¯å·¦å¯„ã› (justify-start)
                    slot.classList.add(index === 0 ? 'justify-end' : 'justify-start');
                    
                    const content = document.createElement('span');
                    content.textContent = part.text;
                    // å˜èªã®é€£çµã‚’è¦–è¦šçš„ã«å¼·èª¿ã™ã‚‹ãŸã‚ã€ãƒãƒ¼ã‚¸ãƒ³ã‚’è¨­å®š
                    content.className = index === 0 ? 'mr-1' : 'ml-1'; 
                    slot.appendChild(content);
                } else {
                    // ã‚¹ãƒ­ãƒƒãƒˆãŒç©ºã®å ´åˆã¯ä¸­å¤®å¯„ã›ã«æˆ»ã™
                    slot.classList.add('justify-center');
                    
                    const placeholder = document.createElement('span');
                    placeholder.textContent = '...';
                    placeholder.className = ''; 
                    slot.appendChild(placeholder);
                }
                
                slot.classList.remove('correct-slot', 'incorrect-slot');
            });
            
            document.querySelectorAll('.word-part').forEach(p => p.classList.remove('selected', 'border-4', 'border-red-500', 'incorrect-part-temp'));
        }
        
        // **ä¿®æ­£ç®‡æ‰€**: æ–‡å­—åˆ—ã«ã‚ˆã‚‹æ­£èª¤åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
        async function checkCombination() {
            isChecking = true;
            targetSlots.forEach(slot => slot.classList.remove('correct-slot', 'incorrect-slot'));
            await new Promise(resolve => setTimeout(resolve, 500));

            const part1 = slottedParts[0]; 
            const part2 = slottedParts[1]; 
            
            if (!part1 || !part2) {
                isChecking = false;
                return;
            }
            
            // çµåˆæ–‡å­—åˆ—ã§åˆ¤å®šã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
            const combinedText = part1.text + part2.text;
            
            // gameWordDataå…¨ä½“ã‹ã‚‰ã€çµåˆæ–‡å­—åˆ—ã¨ä¸€è‡´ã™ã‚‹å˜èªã‚’æ¢ã™
            const matchedWord = gameWordData.find(data => data.full === combinedText);
            
            let isCorrect = !!matchedWord; // ãƒãƒƒãƒã—ãŸå˜èªãŒè¦‹ã¤ã‹ã‚Œã°æ­£è§£

            if (isCorrect) {
                targetSlots.forEach(slot => slot.classList.add('correct-slot'));
                showFeedback(`å˜èªå®Œæˆï¼`, 'success'); 
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // æ­£è§£ãŒè¦‹ã¤ã‹ã£ãŸå˜èªãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦å‡¦ç†ã‚’ç¶™ç¶š (Step 2ã®IDã‚‚å«ã‚€)
                handleSuccess(matchedWord);
            } else {
                // ä¸æ­£è§£ã®å ´åˆã¯ãƒŸã‚¹ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                misses++;
                targetSlots.forEach(slot => slot.classList.add('incorrect-slot'));
                showFeedback(`é–“é•ã„ï¼`, 'error');
                await new Promise(resolve => setTimeout(resolve, 500));
                handleError();
            }

            isChecking = false;
        }

        function handleSuccess(wordData) {
            completedCount++;

            const div = document.createElement('div');
            // wordDataã¯matchedWordã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€æ­£ã—ã„IDãŒåæ˜ ã•ã‚Œã‚‹
            div.className = 'completed-word px-4 py-3 bg-yellow-400 text-gray-800 font-extrabold rounded-xl hover:bg-yellow-500 text-4xl sm:text-5xl shadow-xl w-full border-4 border-transparent';
            div.textContent = wordData.full;
            // å®Œæˆã—ãŸå˜èªã«ã¯ã€ä¸€è‡´ã—ãŸå˜èªã®IDã‚’ä»˜ä¸ã™ã‚‹ (Step 2ã§ä½¿ç”¨)
            div.dataset.id = wordData.id; 
            completedWordsAreaStep1.appendChild(div); 
            
            // ä½¿ç”¨ã—ãŸãƒ‘ãƒ¼ãƒ„ã‚’DOMã‹ã‚‰å®Œå…¨ã«å‰Šé™¤
            slottedParts[0].element.remove();
            slottedParts[1].element.remove();

            slottedParts = [null, null];
            updateVisualSlots();
            
            if (completedCount === gameWordData.length) {
                logFeedback("å…¨å˜èªå®Œæˆï¼Step 2ã¸é€²ã¿ã¾ã™ã€‚", 'success');
                step1Content.style.display = 'none';
                initializeStep2();
            }
        }

        function handleError() {
            // ãƒŸã‚¹ãŒç™ºç”Ÿã—ãŸå ´åˆã€ã‚¹ãƒ­ãƒƒãƒˆã®ãƒ‘ãƒ¼ãƒ„ã‚’æ‰‹æœ­ã«æˆ»ã™
            targetSlots.forEach((slot, index) => {
                if (slottedParts[index]) {
                    const part = slottedParts[index];
                    partsArea.appendChild(part.element);
                }
            });

            slottedParts = [null, null];
            updateVisualSlots();
        }

        let selectedWord = null;
        let selectedTranslation = null;

        function initializeStep2() {
            step2Section.style.display = 'block';
            gameScoreBoard.style.display = 'none'; 
            finalScoreContainer.innerHTML = '';
            step2PairArea.style.display = 'flex'; // STEP2æ“ä½œã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
            completedWordsAreaStep2.innerHTML = ''; 
            translationArea.innerHTML = '';
            finalPairsDisplay.innerHTML = '';

            const wordsToMove = Array.from(completedWordsAreaStep1.children);
            
            shuffle(wordsToMove).forEach(word => {
                word.addEventListener('click', handleStep2Click);
                word.className = 'completed-word px-4 py-3 bg-yellow-400 text-gray-800 font-extrabold rounded-xl hover:bg-yellow-500 text-4xl sm:text-5xl shadow-xl w-full border-4 border-transparent';
                completedWordsAreaStep2.appendChild(word);
            });

            let translations = gameWordData.map(data => ({ text: data.translation, id: data.id }));
            shuffle(translations).forEach(trans => {
                const div = document.createElement('div');
                div.className = 'translation-part px-4 py-3 bg-green-500 text-white font-extrabold rounded-xl hover:bg-green-600 text-4xl sm:text-5xl shadow-xl w-full border-4 border-transparent';
                div.textContent = trans.text;
                div.dataset.id = trans.id;
                div.addEventListener('click', handleStep2Click);
                translationArea.appendChild(div);
            });
            
            logFeedback("Step 2é–‹å§‹: å®Œæˆã—ãŸå˜èªã¨ã€æ­£ã—ã„æ—¥æœ¬èªè¨³ã‚’çµ„ã¿åˆã‚ã›ã‚ˆã†ï¼", 'info');
        }

        function handleStep2Click(event) {
            if (!isGameActive) return;

            const element = event.target;
            const isWord = element.classList.contains('completed-word');
            
            if (element.classList.contains('selected')) {
                element.classList.remove('selected'); 
                if (isWord) {
                    selectedWord = null;
                } else {
                    selectedTranslation = null;
                }
                return;
            }

            if (isWord) {
                if (selectedWord) selectedWord.classList.remove('selected');
                selectedWord = element;
                selectedWord.classList.add('selected');
            } else {
                if (selectedTranslation) selectedTranslation.classList.remove('selected');
                selectedTranslation = element;
                selectedTranslation.classList.add('selected');
            }

            if (selectedWord && selectedTranslation) {
                checkTranslationMatch();
            }
        }

        async function checkTranslationMatch() {
            const wordId = parseInt(selectedWord.dataset.id);
            const translationId = parseInt(selectedTranslation.dataset.id);

            const currentWord = selectedWord;
            const currentTranslation = selectedTranslation;
            
            // Step 2ã¯IDã«ã‚ˆã‚‹åˆ¤å®šã‚’ç¶­æŒ
            if (wordId === translationId) {
                step2MatchCount++;
                showFeedback(`ãƒšã‚¢æˆç«‹ï¼ğŸ‰`, 'success');
                
                await new Promise(resolve => setTimeout(resolve, 1500)); 

                const setDiv = document.createElement('div');
                setDiv.textContent = `${currentWord.textContent} = ${currentTranslation.textContent}`;
                setDiv.className = 'bg-gray-200 p-4 rounded-lg my-1 font-extrabold text-left text-3xl sm:text-4xl';
                finalPairsDisplay.appendChild(setDiv);

                currentWord.remove();
                currentTranslation.remove();
                
                if (step2MatchCount === gameWordData.length) {
                    finalResult(); 
                }
            } else {
                misses++;
                showFeedback(`é–“é•ã„ï¼`, 'error');
                
                await new Promise(resolve => setTimeout(resolve, 1500)); 
                
                currentWord.classList.remove('selected');
                currentTranslation.classList.remove('selected');
            }
            
            selectedWord = null;
            selectedTranslation = null;
        }


        // ----------------------------------------------------------------
        // 8. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¨åˆæœŸåŒ–
        // ----------------------------------------------------------------

        // Home View Listeners
        startSelectedThemeButton.addEventListener('click', startGame);
        newThemeButton.addEventListener('click', () => {
            setupNewTheme();
            setView('manager');
        });

        // Manager View Listeners
        addWordButton.addEventListener('click', addWordToTheme);
        saveThemeButton.addEventListener('click', () => saveTheme(editingTheme));
        backToHomeButton.addEventListener('click', () => setView('home'));
        
        // Import List Listeners
        importListButton.addEventListener('click', handleImportList);


        // Game View Listener
        gameActionButton.addEventListener('click', () => setView('home'));

        window.onload = () => {
             loadThemes();
             setView('home');
        };
    </script>
</body>
</html>