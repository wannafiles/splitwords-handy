<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Split Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        /* ç”»é¢æœ€å¤§åŒ–ã®é©ç”¨ (Req 5 & ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›1) */
        /* bodyã®paddingã‚’å‰Šé™¤ã—ã€overflow-hiddenã‚‚å‰Šé™¤ã—ã¦ã€#game-containerã«ãƒãƒ¼ã‚¸ãƒ³ã‚’ç§»è­² (ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›2: ç”»é¢ä¸‹éƒ¨ãŒè§¦ã‚Œãªã„å•é¡Œã®ä¿®æ­£) */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6; 
            width: 100vw;
            height: 100vh;
            /* overflow: hidden; ã‚’å‰Šé™¤ */
        }
        
        .puzzle-area { min-height: 6rem; } 
        
        /* å˜èªãƒ‘ãƒ¼ãƒ„ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .word-part, .completed-word, .translation-part, .theme-item {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-width: 4px; 
            border-style: solid; 
            border-color: transparent;
        }
        
        /* é¸æŠçŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .selected { 
            box-shadow: 0 6px 12px rgba(79, 70, 229, 0.7); 
            border-color: rgb(79, 70, 229) !important; /* indigo-600 */
        }
        
        .correct-slot { background-color: #34d399 !important; } /* Tailwind green-400 */
        .incorrect-slot { background-color: #f87171 !important; } /* Tailwind red-400 */
        /* ã‚¨ãƒ©ãƒ¼æ™‚ã«ä¸€æ™‚çš„ã«èµ¤ãã™ã‚‹ãƒ”ãƒ¼ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .incorrect-part-temp { background-color: #fca5a5 !important; } /* Tailwind red-300 */

        /* ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¹ãƒ­ãƒƒãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
        .target-slot {
            transition: background-color 0.2s;
            line-height: 5rem; 
            font-weight: 900; 
        }
        
        /* ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢/ã‚ªãƒ¼ãƒãƒ¼æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç”¨ */
        .final-message {
            padding: 1rem;
            margin-top: 1rem;
            font-size: 1.5rem; 
            font-weight: 700;
            text-align: center;
        }

        /* ãƒã‚¤ãƒŠã‚¹ãƒãƒ¼ã‚¸ãƒ³ã‚’é©ç”¨ã—ã¦ä¸Šéƒ¨ã®éš™é–“ã‚’æœ€å°åŒ– */
        .negative-mt-4 { margin-top: -1rem; } 
        
        /* Tema List specific */
        .theme-item {
            border-left-width: 8px;
            border-left-style: solid;
            border-left-color: #4f46e5;
        }

        .required-label::after {
            content: " *";
            color: #ef4444; /* red-500 */
            margin-left: 0.25rem;
        }
    </style>
</head>
<body class="w-screen h-screen bg-gray-50 text-gray-800 antialiased flex items-start justify-center">

    <div id="game-container" class="w-full h-full mx-auto bg-white p-6 sm:p-10 rounded-3xl shadow-2xl border border-gray-100 flex flex-col space-y-4 max-w-7xl overflow-y-auto my-4 sm:my-8">
        
        <div id="control-area" class="flex flex-col items-center justify-center">
            <h1 id="game-title" class="text-5xl sm:text-6xl font-black text-indigo-800 mb-6 text-center">Word Split Challenge</h1>
        </div>
        
        <div id="home-view" class="space-y-6">
            <h2 class="text-3xl font-bold text-gray-700">ãƒ†ãƒ¼ãƒé¸æŠ (ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜)</h2>

            <div id="theme-list" class="flex flex-col space-y-3 p-4 bg-gray-50 rounded-xl min-h-40 shadow-inner">
                <p class="text-gray-500 text-center py-10" id="loading-message">ãƒ†ãƒ¼ãƒã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...</p>
            </div>
            
            <div id="question-count-setting" class="p-4 bg-indigo-50 rounded-xl shadow-inner border-t-4 border-indigo-400">
                <label for="question-limit" class="block text-lg font-bold text-gray-700">å‡ºé¡Œæ•° (å•é¡Œ)</label>
                <input type="number" id="question-limit" min="5" value="10" class="w-full p-3 border border-gray-300 rounded-lg text-2xl focus:ring-indigo-500 focus:border-indigo-500">
                <p id="max-question-info" class="text-sm text-gray-500 mt-1">æœ€å¤§å‡ºé¡Œæ•°: 0 (é¸æŠã—ãŸãƒ†ãƒ¼ãƒã«ä¾å­˜)</p>
            </div>

            <div class="flex flex-col space-y-4">
                <button id="start-selected-theme-button" class="px-6 py-3 bg-green-600 text-white text-xl font-extrabold rounded-xl shadow-md hover:bg-green-700 transition duration-150" disabled>
                    é¸æŠã—ãŸãƒ†ãƒ¼ãƒã§ã‚¹ã‚¿ãƒ¼ãƒˆ
                </button>
                <button id="new-theme-button" class="px-6 py-3 bg-indigo-600 text-white text-xl font-extrabold rounded-xl shadow-md hover:bg-indigo-700 transition duration-150">
                    æ–°ã—ã„ãƒ†ãƒ¼ãƒã‚’ä½œæˆ
                </button>
            </div>
            
             <p class="text-sm text-gray-500 pt-4 text-center">ã“ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ãªãŸã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
        </div>

        <div id="theme-manager-view" class="space-y-6" style="display: none;">
            <h2 id="manager-title" class="text-3xl font-bold text-gray-700">æ–°ã—ã„ãƒ†ãƒ¼ãƒã‚’ä½œæˆ</h2>
            
            <div class="space-y-4 p-4 bg-gray-100 rounded-xl shadow-lg">

                <label for="theme-name" class="block text-lg font-medium text-gray-700 required-label">ãƒ†ãƒ¼ãƒå</label>
                <input type="text" id="theme-name" class="w-full p-3 border border-gray-300 rounded-lg text-2xl focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹: ãƒãƒ­ã‚¦ã‚£ãƒ³å˜èª, å‹•ç‰©ã®åå‰">
                <p id="word-count-info" class="text-sm text-gray-500 text-right">å˜èªæ•°: 0 / æœ€å°5å˜èª</p>
                
                <div class="space-y-4 p-4 bg-purple-50 rounded-xl shadow-lg border-t-4 border-purple-400">
                    <h3 class="text-xl font-bold text-purple-700 flex items-center">
                        ğŸ“‹ ãƒªã‚¹ãƒˆä¸€æ‹¬å–ã‚Šè¾¼ã¿
                    </h3>
                    <p class="text-sm text-gray-600">
                        å¤–éƒ¨ãƒªã‚¹ãƒˆã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ã€ä¸€æ‹¬ã§å˜èªã‚’è¿½åŠ ã§ãã¾ã™ã€‚<br>
                        å½¢å¼: <code>Part1,Part2,æ—¥æœ¬èªè¨³</code> ã¾ãŸã¯ <code>FULLWORD,æ—¥æœ¬èªè¨³</code> (è‡ªå‹•ã§ä¸­å¤®ä»˜è¿‘ã§åˆ†å‰²ã•ã‚Œã¾ã™)
                    </p>
                    <textarea id="import-list-textarea" class="w-full p-3 border border-gray-300 rounded-lg h-32 focus:ring-purple-500 focus:border-purple-500 text-sm" placeholder="ã“ã“ã«ãƒªã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..."></textarea>
                    <button id="import-list-button" class="w-full p-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition duration-150" disabled>
                        ãƒªã‚¹ãƒˆã«å–ã‚Šè¾¼ã¿å®Ÿè¡Œ
                    </button>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-inner space-y-3 border-t-4 border-indigo-400">
                    <h3 class="text-xl font-semibold text-gray-700">å˜èªå€‹åˆ¥è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ </h3>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 required-label">å‰åŠ (Part 1)</label>
                            <input type="text" id="input-part1" class="w-full p-2 border rounded-lg text-lg" placeholder="ä¾‹: JACK-O'">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 required-label">å¾ŒåŠ (Part 2)</label>
                            <input type="text" id="input-part2" class="w-full p-2 border rounded-lg text-lg" placeholder="ä¾‹: LANTERN">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 required-label">æ—¥æœ¬èªè¨³</label>
                            <input type="text" id="input-translation" class="w-full p-2 border rounded-lg text-lg" placeholder="ä¾‹: ã‚¸ãƒ£ãƒƒã‚¯ãƒ»ã‚ªãƒ¼ãƒ»ãƒ©ãƒ³ã‚¿ãƒ³">
                        </div>
                    </div>
                    <button id="add-word-button" class="w-full p-2 bg-purple-500 text-white font-bold rounded-lg hover:bg-purple-600 transition duration-150" disabled>
                        ãƒªã‚¹ãƒˆã«è¿½åŠ 
                    </button>
                </div>
                
                <h3 class="text-xl font-semibold text-gray-700 pt-3">ç¾åœ¨ã®å˜èªãƒªã‚¹ãƒˆ</h3>
                <div id="word-list-editor" class="flex flex-col space-y-2 bg-white p-3 rounded-lg min-h-24 max-h-60 overflow-y-auto">
                    <p class="text-gray-400 text-center py-2">å˜èªãŒã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            </div>

            <div class="flex justify-between space-x-4">
                <button id="back-to-home-button" class="px-6 py-3 bg-gray-500 text-white text-xl font-extrabold rounded-xl shadow-md hover:bg-gray-600 transition duration-150 flex-1">
                    ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
                </button>
                <button id="save-theme-button" class="px-6 py-3 bg-pink-600 text-white text-xl font-extrabold rounded-xl shadow-md hover:bg-pink-700 transition duration-150 flex-1" disabled>
                    ãƒ†ãƒ¼ãƒã‚’ä¿å­˜
                </button>
            </div>
        </div>

        <div id="game-view" style="display: none;">

            <div id="step-1-content" class="negative-mt-4">
                <div id="parts-area" class="puzzle-area flex flex-wrap gap-4 justify-center items-center p-4 bg-gray-50 rounded-xl shadow-inner mb-4">
                    </div>

                <div class="flex flex-col items-center">
                    <div id="target-box" class="flex flex-nowrap justify-center">
                        <div class="target-slot h-24 sm:h-32 bg-gray-200 rounded-l-xl border-4 border-dashed border-gray-400 border-r-0 flex items-center justify-center text-5xl sm:text-7xl font-extrabold text-gray-700 whitespace-nowrap px-4 flex-shrink-0" data-slot="1">...</div>
                        <div class="target-slot h-24 sm:h-32 bg-gray-200 rounded-r-xl border-4 border-dashed border-gray-400 border-l-0 flex items-center justify-center text-5xl sm:text-7xl font-extrabold text-gray-700 whitespace-nowrap px-4 flex-shrink-0" data-slot="2">...</div>
                    </div>
                </div>
                
                <div id="completed-words" style="display: none;">
                </div>
            </div>

            <div id="step-2-section" style="display: none;" class="negative-mt-4">
                
                <div id="game-score-board" class="final-message flex flex-col justify-around items-center p-6 bg-orange-100 rounded-xl shadow-lg mb-8" style="display: none;">
                    <p class="text-2xl sm:text-3xl font-semibold text-gray-700 pt-3">æœ€çµ‚ãƒŸã‚¹å›æ•°: <span id="final-miss-display" class="text-5xl sm:text-6xl text-red-600 font-bold">0</span>å›</p>
                </div>
                
                <div id="step2-pair-area" class="flex flex-col md:flex-row gap-4 mb-4">
                    
                    <div id="english-word-container" class="md:w-1/2 flex flex-col space-y-2 p-3 bg-yellow-100 rounded-xl shadow-md">
                        <div id="completed-words-step2" class="puzzle-area flex flex-wrap gap-2 justify-center items-center p-3 bg-yellow-400 rounded-xl shadow-lg">
                            </div>
                    </div>

                    <div id="japanese-translation-container" class="md:w-1/2 flex flex-col space-y-2 p-3 bg-green-100 rounded-xl shadow-md">
                        <div id="translation-area" class="puzzle-area flex flex-wrap gap-2 justify-center items-center p-3 bg-green-500 rounded-xl shadow-lg">
                            </div>
                    </div>
                </div>
                
                <div id="final-pairs-display" class="mt-4 flex flex-col space-y-3">
                    </div>

                <div id="final-score-container" class="mt-8"></div>
            </div>

            <div id="game-button-wrapper" class="flex justify-center pt-6">
                <button id="game-action-button" class="px-12 py-5 bg-indigo-600 text-white text-3xl sm:text-5xl font-extrabold rounded-full shadow-xl hover:bg-indigo-700 transition duration-150 w-full max-w-sm">
                    ãƒ›ãƒ¼ãƒ ã¸
                </button>
            </div>
        </div>

    </div>

    <div id="feedback-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-300">
        <div id="feedback-content" class="px-10 py-6 rounded-2xl text-white text-6xl font-black shadow-2xl transform scale-105 transition-transform duration-300">
        </div>
    </div>


    <script>
        // ----------------------------------------------------------------
        // 1. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­å®š
        // ----------------------------------------------------------------
        const LOCAL_STORAGE_KEY = 'word_split_challenge_themes';

        // ----------------------------------------------------------------
        // NEW: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ¼ãƒãƒ‡ãƒ¼ã‚¿ç¾¤ (ä¸­1è‹±å˜èªã‚»ãƒƒãƒˆ & æ­´å²äººç‰©)
        // ----------------------------------------------------------------
        
        // æ—¢å­˜ã®ã€Œä¸­1è‹±å˜èªã‚»ãƒƒãƒˆã€ãƒ†ãƒ¼ãƒ
        const DEFAULT_THEME_DATA_EIGO = {
            id: 'default_chu1_eigo',
            name: 'ä¸­1è‹±å˜èªã‚»ãƒƒãƒˆ',
            createdAt: new Date().toISOString(),
            words: [
                { part1: 'YOUR', part2: 'SELF', translation: 'ã‚ãªãŸè‡ªèº«' },
                { part1: 'FLO', part2: 'WER', translation: 'èŠ±' },
                { part1: 'CHA', part2: 'NCE', translation: 'æ©Ÿä¼š' },
                { part1: 'SCI', part2: 'ENCE', translation: 'ç§‘å­¦' },
                { part1: 'CIT', part2: 'IZEN', translation: 'å¸‚æ°‘' },
                { part1: 'SUP', part2: 'PER', translation: 'å¤•é£Ÿ' },
                { part1: 'FAT', part2: 'HER', translation: 'çˆ¶' },
                { part1: 'BRO', part2: 'THER', translation: 'å…„å¼Ÿ' },
                { part1: 'MYS', part2: 'ELF', translation: 'ç§è‡ªèº«ã‚’' },
                { part1: 'YEST', part2: 'ERDAY', translation: 'æ˜¨æ—¥' },
                { part1: 'LIB', part2: 'RARY', translation: 'å›³æ›¸é¤¨' },
                { part1: 'ARR', part2: 'IVE', translation: 'åˆ°ç€ã™ã‚‹' },
                { part1: 'DECE', part2: 'MBER', translation: 'ï¼‘ï¼’æœˆ' },
                { part1: 'NOTE', part2: 'BOOK', translation: 'ãƒãƒ¼ãƒˆ' },
                { part1: 'Oâ€™C', part2: 'LOCK', translation: 'ï½æ™‚' },
                { part1: 'GUI', part2: 'TAR', translation: 'ã‚®ã‚¿ãƒ¼' },
                { part1: 'PRE', part2: 'SENT', translation: 'ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ' },
                { part1: 'MOR', part2: 'NING', translation: 'æœ' },
                { part1: 'HOME', part2: 'WORK', translation: 'å®¿é¡Œ' },
                { part1: 'MIN', part2: 'UTE', translation: 'åˆ†ï¼Œã¡ã‚‡ã£ã¨ã®é–“' },
                { part1: 'CHU', part2: 'RCH', translation: 'æ•™ä¼š' },
                { part1: 'TOGE', part2: 'THER', translation: 'ä¸€ç·’ã«' },
                { part1: 'LET', part2: 'TER', translation: 'æ‰‹ç´™' },
                { part1: 'SUN', part2: 'DAY', translation: 'æ—¥æ›œæ—¥' },
                { part1: 'THE', part2: 'IRS', translation: 'å½¼(å¥³)ã‚‰ã®ã‚‚ã®' },
                { part1: 'WEDN', part2: 'ESDAY', translation: 'æ°´æ›œæ—¥' },
                { part1: 'BASKE', part2: 'TBALL', translation: 'ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«' },
                { part1: 'COMP', part2: 'UTER', translation: 'ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿' },
                { part1: 'SUB', part2: 'JECT', translation: 'ç§‘ç›®ï¼Œé¡Œç›®' },
                { part1: 'OCT', part2: 'OBER', translation: 'ï¼‘ï¼æœˆ' },
                { part1: 'WEA', part2: 'THER', translation: 'å¤©æ°—' },
                { part1: 'DAN', part2: 'GER', translation: 'å±é™º' },
                { part1: 'PEN', part2: 'CIL', translation: 'é‰›ç­†' },
                { part1: 'JAPA', part2: 'NESE', translation: 'æ—¥æœ¬èª' },
                { part1: 'SOC', part2: 'CER', translation: 'ã‚µãƒƒã‚«ãƒ¼' },
                { part1: 'TEA', part2: 'CHER', translation: 'å…ˆç”Ÿ' },
                { part1: 'ITS', part2: 'ELF', translation: 'ãã‚Œè‡ªèº«' },
                { part1: 'INTER', part2: 'ESTING', translation: 'èˆˆå‘³æ·±ã„' },
                { part1: 'FRI', part2: 'DAY', translation: 'é‡‘æ›œæ—¥' },
                { part1: 'HOSP', part2: 'ITAL', translation: 'ç—…é™¢' },
                { part1: 'AME', part2: 'RICA', translation: 'ã‚¢ãƒ¡ãƒªã‚«åˆè¡†å›½' },
                { part1: 'HUN', part2: 'GRY', translation: 'ç©ºè…¹ã®' },
                { part1: 'NOT', part2: 'HING', translation: 'ä½•ã‚‚ï½ãªã„' },
                { part1: 'BIRT', part2: 'HDAY', translation: 'èª•ç”Ÿæ—¥' },
                { part1: 'SATU', part2: 'RDAY', translation: 'åœŸæ›œæ—¥' },
                { part1: 'FRI', part2: 'END', translation: 'å‹äºº' },
                { part1: 'FEBR', part2: 'UARY', translation: 'ï¼’æœˆ' },
                { part1: 'HIM', part2: 'SELF', translation: 'å½¼è‡ªèº«' },
                { part1: 'BREA', part2: 'KFAST', translation: 'æœé£Ÿ' },
                { part1: 'FAM', part2: 'ILY', translation: 'å®¶æ—' },
                { part1: 'DAUG', part2: 'HTER', translation: 'å¨˜' },
                { part1: 'SIS', part2: 'TER', translation: 'å§‰å¦¹' },
                { part1: 'CAR', part2: 'EFUL', translation: 'æ³¨æ„æ·±ã„' },
                { part1: 'COL', part2: 'LECT', translation: 'é›†ã‚ã‚‹' },
                { part1: 'MON', part2: 'DAY', translation: 'æœˆæ›œæ—¥' },
                { part1: 'SOME', part2: 'TIMES', translation: 'æ™‚ã€…' },
                { part1: 'JAN', part2: 'UARY', translation: 'ï¼‘æœˆ' },
                { part1: 'SEA', part2: 'SON', translation: 'å­£ç¯€' },
                { part1: 'HON', part2: 'EST', translation: 'æ­£ç›´ãª' },
                { part1: 'VIL', part2: 'LAGE', translation: 'æ‘' },
                { part1: 'TEN', part2: 'NIS', translation: 'ãƒ†ãƒ‹ã‚¹' },
                { part1: 'DIN', part2: 'NER', translation: 'å¤•é£Ÿ' },
                { part1: 'TUE', part2: 'SDAY', translation: 'ç«æ›œæ—¥' },
                { part1: 'NOVE', part2: 'MBER', translation: 'ï¼‘ï¼‘æœˆ' },
                { part1: 'SUM', part2: 'MER', translation: 'å¤' },
                { part1: 'NUM', part2: 'BER', translation: 'æ•°' },
                { part1: 'SCH', part2: 'OOL', translation: 'å­¦æ ¡' },
                { part1: 'FAVO', part2: 'RITE', translation: 'ä¸€ç•ªå¥½ããª' },
                { part1: 'ALW', part2: 'AYS', translation: 'ã„ã¤ã‚‚' },
                { part1: 'KIT', part2: 'CHEN', translation: 'å°æ‰€' },
                { part1: 'CAN', part2: 'ADA', translation: 'ã‚«ãƒŠãƒ€' },
                { part1: 'NOB', part2: 'ODY', translation: 'ã ã‚Œã‚‚ï½ãªã„' },
                { part1: 'TOMO', part2: 'RROW', translation: 'æ˜æ—¥' },
                { part1: 'SPR', part2: 'ING', translation: 'æ˜¥' },
                { part1: 'AUSTRA', part2: 'LIA', translation: 'ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢' },
                { part1: 'SOME', part2: 'THING', translation: 'ä½•ã‹' },
                { part1: 'AUG', part2: 'UST', translation: 'ï¼˜æœˆ' },
                { part1: 'ANI', part2: 'MAL', translation: 'å‹•ç‰©' },
                { part1: 'AFTE', part2: 'RNOON', translation: 'åˆå¾Œ' },
                { part1: 'OFF', part2: 'ICE', translation: 'äº‹å‹™æ‰€' },
                { part1: 'MOT', part2: 'HER', translation: 'æ¯' },
                { part1: 'WIN', part2: 'DOW', translation: 'çª“' },
                { part1: 'SLO', part2: 'WLY', translation: 'ã‚†ã£ãã‚Šã¨' },
                { part1: 'LIT', part2: 'TLE', translation: 'å°ã•ã„ï¼Œå¹¼ã„ï¼Œã¡ã‚‡ã£ã¨ã—ãŸ' },
                { part1: 'HER', part2: 'SELF', translation: 'å½¼å¥³è‡ªèº«' },
                { part1: 'WIN', part2: 'TER', translation: 'å†¬' },
                { part1: 'THUR', part2: 'SDAY', translation: 'æœ¨æ›œæ—¥' },
                { part1: 'EVERY', part2: 'THING', translation: 'ã™ã¹ã¦ã®ã‚‚ã®' },
                { part1: 'Oâ€™C', part2: 'LOCK', translation: 'ï½æ™‚' },
                { part1: 'PIC', part2: 'TURE', translation: 'çµµï¼Œå†™çœŸ' },
                { part1: 'FRIE', part2: 'NDLY', translation: 'è¦ªã—ã¿ã‚„ã™ã„' },
                { part1: 'STU', part2: 'DENT', translation: 'å­¦ç”Ÿ' },
                { part1: 'SEPT', part2: 'EMBER', translation: 'ï¼™æœˆ' },
                { part1: 'STA', part2: 'TION', translation: 'é§…' },
                { part1: 'FAM', part2: 'OUS', translation: 'æœ‰åãª' },
                { part1: 'BASE', part2: 'BALL', translation: 'é‡çƒ' },
                { part1: 'DOC', part2: 'TOR', translation: 'åŒ»è€…' },
                { part1: 'ORA', part2: 'NGE', translation: 'ã‚ªãƒ¬ãƒ³ã‚¸' },
                { part1: 'EVERY', part2: 'BODY', translation: 'ã ã‚Œã§ã‚‚ã¿ãª' },
                { part1: 'SOM', part2: 'EONE', translation: 'ã ã‚Œã‹' },
                { part1: 'USU', part2: 'ALLY', translation: 'ãµã¤ã†' },
                { part1: 'RAC', part2: 'KET', translation: 'ãƒ©ã‚±ãƒƒãƒˆ' },
                { part1: 'SEC', part2: 'OND', translation: 'ï¼’æ—¥' },
                { part1: 'ALR', part2: 'EADY', translation: 'ã™ã§ã«' },
                { part1: 'EVERY', part2: 'ONE', translation: 'ã¿ã‚“ãª' },
                { part1: 'GAR', part2: 'DEN', translation: 'åº­' },
                { part1: 'STR', part2: 'ONG', translation: 'å¼·ã„ï¼Œã˜ã‚‡ã†ã¶ãª' },
                { part1: 'EVE', part2: 'NING', translation: 'æ™©' },
                { part1: 'PLA', part2: 'YER', translation: 'é¸æ‰‹ï¼Œæ¼”å¥è€…' },
                { part1: 'PEO', part2: 'PLE', translation: 'äººã€…' },
                { part1: 'BEAU', part2: 'TIFUL', translation: 'ç¾ã—ã„' },
                { part1: 'CAM', part2: 'ERA', translation: 'ã‚«ãƒ¡ãƒ©' },
                { part1: 'POP', part2: 'ULAR', translation: 'äººæ°—ã®ã‚ã‚‹' },
                { part1: 'ENG', part2: 'LISH', translation: 'è‹±èª' },
                { part1: 'THEMSE', part2: 'LVES', translation: 'å½¼(å¥³)ã‚‰è‡ªèº«' },
                { part1: 'COU', part2: 'NTRY', translation: 'å›½ï¼Œã„ãªã‹ï¼Œåœ°æ–¹' },
                { part1: 'PAR', part2: 'ENT', translation: 'è¦ª' },
                { part1: 'OURS', part2: 'ELVES', translation: 'ç§ãŸã¡è‡ªèº«ã‚’' },
                { part1: 'JUN', part2: 'IOR', translation: 'å¹´ä¸‹ã®ï¼Œä¸‹ç´šã®' },
                { part1: 'QUES', part2: 'TION', translation: 'è³ªå•' },
                { part1: 'AUT', part2: 'UMN', translation: 'ç§‹' },
                { part1: 'SIN', part2: 'GER', translation: 'æ­Œæ‰‹' },
            ]
        };

        // æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸã€Œæ­´å²äººç‰©ãƒ»ç”¨èªã€ãƒ†ãƒ¼ãƒ
        const DEFAULT_THEME_DATA_HISTORY = {
            id: 'default_rekishi_jinbutsu',
            name: 'æ­´å²äººç‰©ãƒ»ç”¨èª',
            createdAt: new Date().toISOString(),
            words: [
                // äººç‰©åï¼ˆå…¨è§’æ–‡å­—ï¼‰ã¯ã€ä¸­å¤®ã§è‡ªå‹•åˆ†å‰²ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã«åŸºã¥ã„ã¦Part1/Part2ã«åˆ†å‰²ã—ã¦ã„ã¾ã™ã€‚
                { part1: 'å‘', part2: 'å¼¥å‘¼', translation: 'é‚ªé¦¬å°å›½ã®å¥³ç‹' },
                { part1: 'è–å¾³', part2: 'å¤ªå­', translation: 'å† ä½åäºŒéš' },
                { part1: 'é‘‘', part2: 'çœŸ', translation: 'é£å”ä½¿èˆ¹ã§æ¥æ—¥' },
                { part1: 'å±±ä¸Š', part2: 'æ†¶è‰¯', translation: 'è²§çª®å•ç­”æ­Œ' },
                { part1: 'å‚ä¸Šç”°', part2: 'æ‘éº»å‘‚', translation: 'è¦å¤·ã¨æˆ¦ã£ãŸå¾å¤·å¤§å°†è»' },
                { part1: 'è—¤åŸ', part2: 'é ¼é€š', translation: 'å¹³ç­‰é™¢é³³å‡°å ‚' },
                { part1: 'å¹³', part2: 'å°†é–€', translation: 'æ–°çš‡ã¨åä¹—ã‚Šé–¢æ±ã§åä¹±' },
                { part1: 'æœ€', part2: 'æ¾„', part2_kana: 'ã•ã„ã¡ã‚‡ã†', translation: 'æ¯”å¡å±±ãƒ»å»¶æš¦å¯ºãƒ»å¤©å°å®—' },
                { part1: 'ç©º', part2: 'æµ·', translation: 'é«˜é‡å±±ãƒ»é‡‘å‰›å³¯å¯ºãƒ»çœŸè¨€å®—' },
                { part1: 'ç´«', part2: 'å¼éƒ¨', translation: 'æºæ°ç‰©èª' },
                { part1: 'æ¸…å°‘', part2: 'ç´è¨€', translation: 'æ•è‰å­' },
                { part1: 'ç´€', part2: 'è²«ä¹‹', translation: 'å¤ä»Šå’Œæ­Œé›†ã®é¸è€…' },
                { part1: 'å¹³', part2: 'æ¸…ç››', translation: 'å¤ªæ”¿å¤§è‡£ãƒ»æ­¦å£«ã§æ”¿æ²»ã®å®Ÿæ¨©' },
                { part1: 'æº', part2: 'é ¼æœ', translation: 'å¾å¤·å¤§å°†è»ãƒ»éŒå€‰å¹•åºœã‚’é–‹ã„ãŸ' },
                { part1: 'å¾Œé³¥', part2: 'ç¾½ä¸Šçš‡', translation: 'æ‰¿ä¹…ã®ä¹±ã§æ•—ã‚Œã€éš å²ã«æµã•ã‚ŒãŸ' },
                { part1: 'åŒ—æ¡', part2: 'æ³°æ™‚', translation: 'å¾¡æˆæ•—å¼ç›®' },
                { part1: 'å¾Œé†', part2: 'é†å¤©çš‡', translation: 'å»ºæ­¦ã®æ–°æ”¿' },
                { part1: 'è¶³åˆ©', part2: 'å°Šæ°', translation: 'å¾å¤·å¤§å°†è»ãƒ»äº¬éƒ½ã«å¹•åºœã‚’é–‹ã„ãŸ' },
                { part1: 'è¶³åˆ©', part2: 'ç¾©æº€', translation: 'é‡‘é–£å¯ºã‚’å»ºã¦ãŸ' },
                { part1: 'è¶³åˆ©', part2: 'ç¾©æ”¿', translation: 'éŠ€é–£å¯ºã‚’å»ºã¦ãŸ' },
                { part1: 'å°š', part2: 'æ°', translation: 'ç‰çƒç‹å›½' },
                { part1: 'æ³•', part2: 'ç„¶', translation: 'æµ„åœŸå®—' },
                { part1: 'è¦ª', part2: 'é¸', translation: 'æµ„åœŸçœŸå®—' },
                { part1: 'å‰ç”°', part2: 'å…¼å¥½', translation: 'å¾’ç„¶è‰' },
                { part1: 'é›ª', part2: 'èˆŸ', translation: 'æ°´å¢¨ç”»' },
                { part1: 'ãƒ•ãƒ©ãƒ³ã‚·ã‚³', part2: 'ãƒ»ã‚¶ãƒ“ã‚¨ãƒ«', translation: 'ã‚­ãƒªã‚¹ãƒˆæ•™ãƒ»å®£æ•™å¸«' },
                { part1: 'ç¹”ç”°', part2: 'ä¿¡é•·', translation: 'æ¡¶ç‹­é–“ã®æˆ¦ã„ãƒ»ä»Šå·ç¾©å…ƒã‚’ç ´ã£ãŸ' },
                { part1: 'è±Šè‡£', part2: 'ç§€å‰', translation: '1590å¹´ã«å…¨å›½ã‚’çµ±ä¸€' },
                { part1: 'åƒ', part2: 'åˆ©ä¼‘', translation: 'èŒ¶ã®æ¹¯' },
                { part1: 'å¾³å·', part2: 'å®¶åº·', translation: 'æ±Ÿæˆ¸å¹•åºœã‚’é–‹ã„ãŸ' },
                { part1: 'å¾³å·', part2: 'å®¶å…‰', translation: 'å‚å‹¤äº¤ä»£' },
                { part1: 'å¾³å·', part2: 'ç¶±å‰', translation: 'ç”Ÿé¡æ†ã¿ã®ä»¤' },
                { part1: 'å¾³å·', part2: 'å‰å®—', translation: 'äº«ä¿ã®æ”¹é©' },
                { part1: 'æ¾å¹³', part2: 'å®šä¿¡', translation: 'å¯›æ”¿ã®æ”¹é©' },
                { part1: 'æ°´é‡', part2: 'å¿ é‚¦', translation: 'å¤©ä¿ã®æ”¹é©' },
                { part1: 'äº•åŸ', part2: 'è¥¿é¶´', translation: 'æµ®ä¸–è‰å­ã€Œå¥½è‰²ä¸€ä»£ç”·ã€' },
                { part1: 'è¿‘æ¾é–€', part2: 'å·¦è¡›é–€', translation: 'äººå½¢æµ„ç‘ ç’ƒã€Œæ›½æ ¹å´å¿ƒä¸­ã€' },
                { part1: 'æ­Œå·', part2: 'åºƒé‡', translation: 'æµ®ä¸–çµµã€Œæ±æµ·é“äº”åä¸‰æ¬¡ã€' },
                { part1: 'è‘›é£¾', part2: 'åŒ—æ–', translation: 'é¢¨æ™¯ç”»ã€Œå¯Œå¶½ä¸‰åå…­æ™¯ã€' },
                { part1: 'æ¾å°¾', part2: 'èŠ­è•‰', translation: 'ç´€è¡Œæ–‡ã€ŒãŠãã®ã»ãé“ã€' },
                { part1: 'æœ¬å±…', part2: 'å®£é•·', translation: 'å¤äº‹è¨˜ä¼' },
                { part1: 'ä¼Šèƒ½', part2: 'å¿ æ•¬', translation: 'å…¨å›½ã‚’æ¸¬é‡' },
                { part1: 'ãƒš', part2: 'ãƒªãƒ¼', translation: 'æµ¦è³€æ²–ã«æ¥èˆªãƒ»é–‹å›½ã‚’ã›ã¾ã£ãŸ' },
                { part1: 'äº•ä¼Š', part2: 'ç›´å¼¼', translation: 'æ—¥ç±³ä¿®å¥½é€šå•†æ¡ç´„ã‚’ç· çµ' },
                { part1: 'å¾³å·', part2: 'æ…¶å–œ', translation: 'å¤§æ”¿å¥‰é‚„' },
                { part1: 'ç¦æ²¢', part2: 'è«­å‰', translation: 'ã€Œå­¦å•ã®ã™ã™ã‚ã€' },
                { part1: 'è¥¿éƒ·', part2: 'éš†ç››', translation: 'å¾éŸ“è«–ã§æ”¿åºœã‚’å»ã‚Šã€é¹¿å…å³¶ã§æŒ™å…µ' },
                { part1: 'ä¼Šè—¤', part2: 'åšæ–‡', translation: 'åˆä»£ã®å†…é–£ç·ç†å¤§è‡£' },
                { part1: 'å°æ‘', part2: 'å¯¿å¤ªéƒ', translation: 'é–¢ç¨è‡ªä¸»æ¨©ã®å›å¾©' },
                { part1: 'ç”°ä¸­', part2: 'æ­£é€ ', translation: 'è¶³å°¾é‰±æ¯’äº‹ä»¶' },
            ]
        };

        // å…¨ã¦ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ¼ãƒã‚’æ ¼ç´ã™ã‚‹é…åˆ—
        const ALL_DEFAULT_THEMES = [
            DEFAULT_THEME_DATA_EIGO,
            DEFAULT_THEME_DATA_HISTORY 
        ];


        // ----------------------------------------------------------------
        // 2. DOMè¦ç´ ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
        // ----------------------------------------------------------------
        
        // UI Views
        const homeView = document.getElementById('home-view');
        const themeManagerView = document.getElementById('theme-manager-view');
        const gameView = document.getElementById('game-view');
        const managerTitle = document.getElementById('manager-title');
        const gameTitle = document.getElementById('game-title');

        // Home Elements
        const themeList = document.getElementById('theme-list');
        const startSelectedThemeButton = document.getElementById('start-selected-theme-button');
        const newThemeButton = document.getElementById('new-theme-button');
        const loadingMessage = document.getElementById('loading-message');

        // Question Limit Elements
        const questionLimitInput = document.getElementById('question-limit');
        const maxQuestionInfo = document.getElementById('max-question-info');

        // Manager Elements
        const themeNameInput = document.getElementById('theme-name');
        const inputPart1 = document.getElementById('input-part1');
        const inputPart2 = document.getElementById('input-part2');
        const inputTranslation = document.getElementById('input-translation');
        const addWordButton = document.getElementById('add-word-button');
        const wordListEditor = document.getElementById('word-list-editor');
        const saveThemeButton = document.getElementById('save-theme-button');
        const backToHomeButton = document.getElementById('back-to-home-button');
        const wordCountInfo = document.getElementById('word-count-info');

        // Import Elements
        const importListTextarea = document.getElementById('import-list-textarea');
        const importListButton = document.getElementById('import-list-button');

        // Game Elements (æ—¢å­˜)
        const partsArea = document.getElementById('parts-area');
        const targetSlots = document.querySelectorAll('.target-slot');
        const completedWordsAreaStep1 = document.getElementById('completed-words');
        const completedWordsAreaStep2 = document.getElementById('completed-words-step2');
        const translationArea = document.getElementById('translation-area');
        const gameActionButton = document.getElementById('game-action-button');
        const gameButtonWrapper = document.getElementById('game-button-wrapper');
        const gameScoreBoard = document.getElementById('game-score-board');
        const finalMissDisplay = document.getElementById('final-miss-display');
        const step1Content = document.getElementById('step-1-content');
        const step2Section = document.getElementById('step-2-section');
        const finalPairsDisplay = document.getElementById('final-pairs-display');
        const step2PairArea = document.getElementById('step2-pair-area');
        const finalScoreContainer = document.getElementById('final-score-container');
        
        // Feedback
        const feedbackOverlay = document.getElementById('feedback-overlay');
        const feedbackContent = document.getElementById('feedback-content');

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
        let currentView = 'home';
        let allThemes = [];
        let selectedTheme = null;
        let editingTheme = { id: null, name: '', words: [] };
        let questionLimit = 10;

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let gameWordData = [];
        let misses = 0;
        let completedCount = 0;
        let step2MatchCount = 0;
        let isGameActive = false;
        let isChecking = false;
        let slottedParts = [null, null];

        // ----------------------------------------------------------------
        // 3. UI/View åˆ¶å¾¡ & ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        // ----------------------------------------------------------------

        function setView(view) {
            currentView = view;
            homeView.style.display = 'none';
            themeManagerView.style.display = 'none';
            gameView.style.display = 'none';

            // Req 1: ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤ºã®åˆ¶å¾¡
            if (view === 'game') {
                gameTitle.style.display = 'none';
            } else {
                gameTitle.style.display = 'block';
            }

            if (view === 'home') {
                homeView.style.display = 'block';
                selectedTheme = null;
                startSelectedThemeButton.disabled = true;
                loadThemes(); 
            } else if (view === 'manager') {
                themeManagerView.style.display = 'block';
                // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
                importListTextarea.value = '';
                importListButton.disabled = true;
                updateManagerUI();
            } else if (view === 'game') {
                gameView.style.display = 'block';
            }
        }

        function logFeedback(text, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${text}`);
        }

        function showFeedback(message, type) {
            feedbackContent.className = 'px-10 py-6 rounded-2xl text-white text-6xl font-black shadow-2xl transform scale-105 transition-transform duration-300';
            if (type === 'success') {
                feedbackContent.textContent = 'âœ… ' + message;
                feedbackContent.classList.add('bg-green-600');
            } else if (type === 'error') {
                feedbackContent.textContent = 'âŒ ' + message;
                feedbackContent.classList.add('bg-red-600');
            }
            feedbackOverlay.classList.remove('opacity-0', 'pointer-events-none');
            
            setTimeout(() => {
                feedbackOverlay.classList.add('opacity-0', 'pointer-events-none');
            }, 1500);
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // ----------------------------------------------------------------
        // 4. ãƒ†ãƒ¼ãƒã®æ°¸ç¶šåŒ– (localStorage)
        // ----------------------------------------------------------------

        function generateUniqueId() {
            return 'theme_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function saveThemesToLocal() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allThemes));
                logFeedback('Themes successfully saved to localStorage.', 'local');
            } catch (e) {
                logFeedback(`Error saving to localStorage: ${e.message}`, 'error');
                showFeedback('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
            }
        }

        function loadThemes() {
            loadingMessage.style.display = 'block';
            loadingMessage.textContent = 'ãƒ†ãƒ¼ãƒã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...';

            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                let loadedThemes = data ? JSON.parse(data) : [];

                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ¼ãƒã‚’ãƒ­ãƒ¼ãƒ‰
                ALL_DEFAULT_THEMES.forEach(defaultTheme => {
                    const exists = loadedThemes.some(theme => theme.id === defaultTheme.id);
                    if (!exists) {
                        loadedThemes.push(defaultTheme);
                    }
                });

                allThemes = loadedThemes;
                renderThemeList();
                logFeedback(`Themes loaded: ${allThemes.length} items.`, 'local');

            } catch (e) {
                logFeedback(`Error loading themes: ${e.message}`, 'error');
                showFeedback('ãƒ†ãƒ¼ãƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
            } finally {
                loadingMessage.style.display = 'none';
                if (allThemes.length === 0) {
                    loadingMessage.textContent = 'ãƒ†ãƒ¼ãƒãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ–°ã—ã„ãƒ†ãƒ¼ãƒã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚';
                    loadingMessage.style.display = 'block';
                }
            }
        }

        function renderThemeList() {
            themeList.innerHTML = '';
            if (allThemes.length === 0) {
                loadingMessage.textContent = 'ãƒ†ãƒ¼ãƒãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ–°ã—ã„ãƒ†ãƒ¼ãƒã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚';
                loadingMessage.style.display = 'block';
                return;
            }

            allThemes.forEach(theme => {
                const themeElement = document.createElement('div');
                themeElement.className = `theme-item p-4 rounded-xl shadow cursor-pointer transition duration-150 flex justify-between items-center ${selectedTheme && selectedTheme.id === theme.id ? 'bg-indigo-200 border-indigo-600' : 'bg-white hover:bg-gray-100 border-gray-200'}`;
                themeElement.dataset.themeId = theme.id;
                
                const wordCount = theme.words ? theme.words.length : 0;
                
                themeElement.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <p class="text-xl font-bold text-indigo-700 truncate">${theme.name}</p>
                        <p class="text-sm text-gray-500">${wordCount} å˜èª (${new Date(theme.createdAt).toLocaleDateString()})</p>
                    </div>
                    <div class="flex space-x-2 ml-4">
                         <button data-action="edit" class="p-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 text-sm font-semibold transition duration-150">
                            ç·¨é›†
                        </button>
                        ${theme.id.startsWith('default_') ? 
                            `<button class="p-2 bg-gray-400 text-white rounded-lg text-sm font-semibold cursor-not-allowed" disabled>å‰Šé™¤</button>` :
                            `<button data-action="delete" class="p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm font-semibold transition duration-150">å‰Šé™¤</button>`
                        }
                    </div>
                `;

                themeElement.addEventListener('click', (e) => {
                    if (e.target.dataset.action === 'edit') {
                        setupEditTheme(theme);
                        setView('manager');
                    } else if (e.target.dataset.action === 'delete') {
                        deleteTheme(theme.id, theme.name);
                    } else {
                        selectTheme(theme);
                    }
                });

                themeList.appendChild(themeElement);
            });
            
            // é¸æŠçŠ¶æ…‹ã®å¾©å…ƒ
            if (selectedTheme) {
                selectTheme(selectedTheme);
            }
        }

        function selectTheme(theme) {
            selectedTheme = theme;
            startSelectedThemeButton.disabled = false;
            
            // æœ€å¤§å‡ºé¡Œæ•°ã®è¡¨ç¤ºã‚’æ›´æ–°
            const maxWords = selectedTheme.words.length;
            maxQuestionInfo.textContent = `æœ€å¤§å‡ºé¡Œæ•°: ${maxWords} (é¸æŠã—ãŸãƒ†ãƒ¼ãƒã«ä¾å­˜)`;
            questionLimitInput.max = maxWords;
            if (parseInt(questionLimitInput.value) > maxWords) {
                questionLimitInput.value = maxWords > 0 ? maxWords : 5;
            }

            // UIã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.theme-item').forEach(el => {
                if (el.dataset.themeId === theme.id) {
                    el.classList.add('bg-indigo-200', 'border-indigo-600');
                    el.classList.remove('bg-white', 'hover:bg-gray-100', 'border-gray-200');
                } else {
                    el.classList.remove('bg-indigo-200', 'border-indigo-600');
                    el.classList.add('bg-white', 'hover:bg-gray-100', 'border-gray-200');
                }
            });
        }
        
        function deleteTheme(id, name) {
            if (confirm(`æœ¬å½“ã«ãƒ†ãƒ¼ãƒã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
                allThemes = allThemes.filter(theme => theme.id !== id);
                if (selectedTheme && selectedTheme.id === id) {
                    selectedTheme = null;
                    startSelectedThemeButton.disabled = true;
                    maxQuestionInfo.textContent = 'æœ€å¤§å‡ºé¡Œæ•°: 0 (é¸æŠã—ãŸãƒ†ãƒ¼ãƒã«ä¾å­˜)';
                }
                saveThemesToLocal();
                renderThemeList();
                showFeedback('ãƒ†ãƒ¼ãƒã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            }
        }

        // ----------------------------------------------------------------
        // 5. ãƒ†ãƒ¼ãƒç®¡ç† (Manager View) 
        // ----------------------------------------------------------------

        function setupNewTheme() {
            editingTheme = { id: generateUniqueId(), name: '', words: [] };
            themeNameInput.value = '';
            managerTitle.textContent = 'æ–°ã—ã„ãƒ†ãƒ¼ãƒã‚’ä½œæˆ';
            updateManagerUI();
        }

        function setupEditTheme(theme) {
            editingTheme = JSON.parse(JSON.stringify(theme)); // deep copy
            themeNameInput.value = editingTheme.name;
            managerTitle.textContent = `ãƒ†ãƒ¼ãƒã€Œ${editingTheme.name}ã€ã‚’ç·¨é›†`;
            updateManagerUI();
        }

        function updateManagerUI() {
            // å˜èªãƒªã‚¹ãƒˆã®è¡¨ç¤º
            wordListEditor.innerHTML = '';
            const words = editingTheme.words;

            if (words.length === 0) {
                wordListEditor.innerHTML = '<p class="text-gray-400 text-center py-2">å˜èªãŒã‚ã‚Šã¾ã›ã‚“</p>';
                saveThemeButton.disabled = true;
            } else {
                words.forEach((word, index) => {
                    const wordElement = document.createElement('div');
                    wordElement.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-lg border border-gray-200';
                    wordElement.innerHTML = `
                        <p class="text-sm font-medium text-gray-800 flex-1 min-w-0 break-all">${word.part1} | ${word.part2} <span class="text-gray-500 ml-2">(${word.translation})</span></p>
                        <button data-index="${index}" data-action="remove" class="ml-4 p-1 text-red-500 hover:text-red-700 transition duration-150">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    `;
                    wordListEditor.appendChild(wordElement);
                });
                
                // ç·¨é›†ä¸­ã®ãƒ†ãƒ¼ãƒãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
                checkThemeValidity();
            }

            // å˜èªæ•°ã®è¡¨ç¤ºæ›´æ–°
            wordCountInfo.textContent = `å˜èªæ•°: ${words.length} / æœ€å°5å˜èª`;
            
            // ãƒªã‚¹ãƒŠãƒ¼ã®å†è¨­å®š (å‹•çš„ç”Ÿæˆã•ã‚ŒãŸå‰Šé™¤ãƒœã‚¿ãƒ³)
            wordListEditor.querySelectorAll('button[data-action="remove"]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    removeWordFromTheme(index);
                });
            });
        }

        function checkThemeValidity() {
            const isValid = editingTheme.words.length >= 5 && editingTheme.name.trim() !== '';
            saveThemeButton.disabled = !isValid;
        }

        function addWordToTheme() {
            const part1 = inputPart1.value.trim();
            const part2 = inputPart2.value.trim();
            const translation = inputTranslation.value.trim();

            if (!part1 || !part2 || !translation) {
                showFeedback('å…¨ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            const newWord = { part1: part1, part2: part2, translation: translation };

            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            const fullWord = part1 + part2;
            if (editingTheme.words.some(w => w.part1 + w.part2 === fullWord)) {
                showFeedback('åŒã˜å˜èªã¯æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™', 'error');
                return;
            }

            editingTheme.words.push(newWord);
            updateManagerUI();

            // ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¯ãƒªã‚¢
            inputPart1.value = '';
            inputPart2.value = '';
            inputTranslation.value = '';
            inputPart1.focus();

            showFeedback('å˜èªã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
        }

        function removeWordFromTheme(index) {
            editingTheme.words.splice(index, 1);
            updateManagerUI();
        }

        function saveTheme(themeToSave) {
            themeToSave.name = themeNameInput.value.trim();

            if (themeToSave.name === '') {
                showFeedback('ãƒ†ãƒ¼ãƒåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (themeToSave.words.length < 5) {
                 showFeedback('æœ€ä½5å˜èªå¿…è¦ã§ã™ã€‚', 'error');
                return;
            }

            // æ—¢å­˜ã®ãƒ†ãƒ¼ãƒã‚’æ›´æ–°ã¾ãŸã¯æ–°ã—ã„ãƒ†ãƒ¼ãƒã‚’è¿½åŠ 
            const existingIndex = allThemes.findIndex(t => t.id === themeToSave.id);
            if (existingIndex !== -1) {
                // æ›´æ–°
                allThemes[existingIndex] = themeToSave;
                showFeedback('ãƒ†ãƒ¼ãƒã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            } else {
                // æ–°è¦è¿½åŠ 
                themeToSave.createdAt = new Date().toISOString();
                allThemes.push(themeToSave);
                showFeedback('æ–°ã—ã„ãƒ†ãƒ¼ãƒã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
            }

            saveThemesToLocal();
            setView('home'); // ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
        }
        
        function handleImportList() {
            const listText = importListTextarea.value.trim();
            if (!listText) return;

            const lines = listText.split('\n').filter(line => line.trim() !== '');
            let importedCount = 0;

            lines.forEach(line => {
                const parts = line.split(',').map(p => p.trim());
                let part1, part2, translation;

                if (parts.length === 3) {
                    // Part1, Part2, æ—¥æœ¬èªè¨³ ã®å½¢å¼
                    [part1, part2, translation] = parts;
                } else if (parts.length === 2) {
                    // FULLWORD, æ—¥æœ¬èªè¨³ ã®å½¢å¼
                    const fullWord = parts[0];
                    translation = parts[1];
                    // ä¸­å¤®ä»˜è¿‘ã§åˆ†å‰²
                    const splitIndex = Math.ceil(fullWord.length / 2);
                    part1 = fullWord.substring(0, splitIndex);
                    part2 = fullWord.substring(splitIndex);
                } else {
                    return; // ç„¡åŠ¹ãªè¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
                }

                if (part1 && part2 && translation) {
                    const fullWord = part1 + part2;
                     // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                    if (editingTheme.words.some(w => w.part1 + w.part2 === fullWord)) {
                        return; // é‡è¤‡ã¯ã‚¹ã‚­ãƒƒãƒ—
                    }
                    editingTheme.words.push({ part1, part2, translation });
                    importedCount++;
                }
            });

            if (importedCount > 0) {
                updateManagerUI();
                importListTextarea.value = ''; // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
                showFeedback(`${importedCount}å€‹ã®å˜èªã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸ`, 'success');
            } else {
                showFeedback('æœ‰åŠ¹ãªå˜èªã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'error');
            }
        }
        
        // ç›£è¦–: ãƒ†ãƒ¼ãƒåã€å€‹åˆ¥å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã€ä¸€æ‹¬å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
        themeNameInput.addEventListener('input', checkThemeValidity);
        
        inputPart1.addEventListener('input', () => {
             addWordButton.disabled = !(inputPart1.value.trim() && inputPart2.value.trim() && inputTranslation.value.trim());
        });
        inputPart2.addEventListener('input', () => {
             addWordButton.disabled = !(inputPart1.value.trim() && inputPart2.value.trim() && inputTranslation.value.trim());
        });
        inputTranslation.addEventListener('input', () => {
             addWordButton.disabled = !(inputPart1.value.trim() && inputPart2.value.trim() && inputTranslation.value.trim());
        });

        importListTextarea.addEventListener('input', () => {
            importListButton.disabled = importListTextarea.value.trim() === '';
        });


        // ----------------------------------------------------------------
        // 6. ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ (Step 1: å˜èªãƒ‘ãƒ¼ãƒ„ã®çµ„ã¿ç«‹ã¦)
        // ----------------------------------------------------------------

        function startGame() {
            if (!selectedTheme || selectedTheme.words.length < 5) {
                showFeedback('æœ‰åŠ¹ãªãƒ†ãƒ¼ãƒã‚’é¸æŠã—ã¦ãã ã•ã„ (5å˜èªä»¥ä¸Š)', 'error');
                return;
            }
            
            // çŠ¶æ…‹ã®ãƒªã‚»ãƒƒãƒˆ
            questionLimit = Math.min(parseInt(questionLimitInput.value), selectedTheme.words.length);
            misses = 0;
            completedCount = 0;
            step2MatchCount = 0;
            isGameActive = true;
            slottedParts = [null, null];

            // UIã®ãƒªã‚»ãƒƒãƒˆ
            partsArea.innerHTML = '';
            completedWordsAreaStep1.innerHTML = '';
            completedWordsAreaStep1.style.display = 'none';
            gameScoreBoard.style.display = 'none';
            step1Content.style.display = 'block';
            step2Section.style.display = 'none';
            gameActionButton.textContent = 'æ¬¡ã®å•é¡Œã¸';
            gameActionButton.onclick = checkAnswer; // ã‚¯ãƒªãƒƒã‚¯ã§æ¬¡ã®å•é¡Œã¸é€²ã‚€ï¼ˆæœ€åˆã¯å›ç­”ãƒã‚§ãƒƒã‚¯ï¼‰

            // å‡ºé¡Œã™ã‚‹å˜èªã®é¸æŠã¨ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            const allWords = shuffle(selectedTheme.words);
            gameWordData = allWords.slice(0, questionLimit);

            // ã‚¹ãƒ†ãƒ¼ã‚¸ã®é–‹å§‹
            loadNextWord();
            setView('game');
        }

        let currentWordIndex = 0;
        let currentTargetWord = null;
        let availableParts = [];
        let selectedPartElement = null;

        function loadNextWord() {
            if (currentWordIndex >= questionLimit) {
                endGame();
                return;
            }

            currentTargetWord = gameWordData[currentWordIndex];
            availableParts = shuffle([
                { part: currentTargetWord.part1, slot: 1, element: null },
                { part: currentTargetWord.part2, slot: 2, element: null }
            ]);

            // UIã®æ›´æ–°
            partsArea.innerHTML = '';
            targetSlots[0].textContent = '...';
            targetSlots[1].textContent = '...';
            targetSlots[0].classList.remove('correct-slot', 'incorrect-slot');
            targetSlots[1].classList.remove('correct-slot', 'incorrect-slot');
            
            slottedParts = [null, null];
            selectedPartElement = null;
            
            gameActionButton.textContent = 'å›ç­”ãƒã‚§ãƒƒã‚¯';
            gameActionButton.onclick = checkAnswer; 
            
            renderParts();
        }
        
        function renderParts() {
            partsArea.innerHTML = '';
            availableParts.forEach(wordPart => {
                const partElement = document.createElement('div');
                // w-autoã¨px-4ã‚’è¿½åŠ ã—ã€å†…å®¹ã«å¿œã˜ã¦å¹…ã‚’èª¿æ•´
                partElement.className = 'word-part px-4 py-2 bg-indigo-500 text-white rounded-lg text-xl sm:text-3xl font-bold hover:bg-indigo-600';
                partElement.textContent = wordPart.part;
                partElement.dataset.slot = wordPart.slot; // æ­£ã—ã„ã‚¹ãƒ­ãƒƒãƒˆ
                
                partElement.addEventListener('click', () => handlePartClick(partElement, wordPart));
                
                wordPart.element = partElement;
                partsArea.appendChild(partElement);
            });
        }
        
        function handlePartClick(element, partData) {
            if (isChecking || element.classList.contains('slotted')) return;
            
            // é¸æŠ/é¸æŠè§£é™¤ã®å‡¦ç†
            if (selectedPartElement === element) {
                element.classList.remove('selected');
                selectedPartElement = null;
            } else {
                // å‰ã®é¸æŠã‚’è§£é™¤
                if (selectedPartElement) {
                    selectedPartElement.classList.remove('selected');
                }
                // æ–°ã—ã„ãƒ”ãƒ¼ã‚¹ã‚’é¸æŠ
                selectedPartElement = element;
                element.classList.add('selected');
            }
            
            // ã‚¹ãƒ­ãƒƒãƒˆã¸ã®é…ç½®ã‚’è©¦ã¿ã‚‹
            if (selectedPartElement) {
                // 1. ã‚¹ãƒ­ãƒƒãƒˆ1ãŒç©ºã„ã¦ã„ã‚Œã°ã€ãã“ã«é…ç½®
                if (!slottedParts[0]) {
                    placePart(element, partData, 1);
                } 
                // 2. ã‚¹ãƒ­ãƒƒãƒˆ1ãŒåŸ‹ã¾ã£ã¦ã„ã¦ã€ã‚¹ãƒ­ãƒƒãƒˆ2ãŒç©ºã„ã¦ã„ã‚Œã°ã€ãã“ã«é…ç½®
                else if (!slottedParts[1]) {
                    placePart(element, partData, 2);
                } 
                // 3. ä¸¡æ–¹åŸ‹ã¾ã£ã¦ã„ã‚‹å ´åˆã€ç¾åœ¨ã®é¸æŠã‚’è§£é™¤ã™ã‚‹ã ã‘ã«ã™ã‚‹
                else {
                    // ä½•ã‚‚ã—ãªã„ï¼ˆã¾ãŸã¯ã€ã™ã§ã«é…ç½®ã•ã‚Œã¦ã„ã‚‹ãƒ”ãƒ¼ã‚¹ã‚’ã‚¿ãƒƒãƒ—ã§æˆ»ã™ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ å¯èƒ½ï¼‰
                }
            }
        }
        
        function placePart(element, partData, slotIndex) {
            const targetSlot = targetSlots[slotIndex - 1]; // targetSlotsã¯0-indexed
            
            // ã‚¹ãƒ­ãƒƒãƒˆã«é…ç½®
            targetSlot.textContent = partData.part;
            targetSlot.dataset.partId = partData.part; // é…ç½®ã•ã‚ŒãŸãƒ”ãƒ¼ã‚¹ã‚’è­˜åˆ¥
            
            // é¸æŠçŠ¶æ…‹ã‚’è§£é™¤ã—ã€ã‚¹ãƒ­ãƒƒãƒˆæ¸ˆã¿ã¨ã—ã¦ãƒãƒ¼ã‚¯
            element.classList.remove('selected');
            element.classList.add('slotted');
            element.style.display = 'none'; // ãƒ”ãƒ¼ã‚¹ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            
            // çŠ¶æ…‹ã‚’æ›´æ–°
            slottedParts[slotIndex - 1] = { part: partData.part, correctSlot: partData.slot, element: element };
            selectedPartElement = null;
            
            // ã‚¹ãƒ­ãƒƒãƒˆã‹ã‚‰ãƒ”ãƒ¼ã‚¹ã‚’å–ã‚Šæˆ»ã™ãƒ­ã‚¸ãƒƒã‚¯
            targetSlot.onclick = () => removePart(slotIndex, targetSlot, element);
            
            // ä¸¡æ–¹ã®ã‚¹ãƒ­ãƒƒãƒˆãŒåŸ‹ã¾ã£ãŸã‚‰ã€è‡ªå‹•ã§å›ç­”ãƒã‚§ãƒƒã‚¯ã«é€²ã‚€ã‚ˆã†ã«ä¿ƒã™
            if (slottedParts[0] && slottedParts[1]) {
                 gameActionButton.textContent = 'å›ç­”ãƒã‚§ãƒƒã‚¯';
                 checkAnswer(); 
            }
        }
        
        function removePart(slotIndex, targetSlot, partElement) {
            if (isChecking) return;
            
            targetSlot.textContent = '...';
            targetSlot.dataset.partId = ''; 
            targetSlot.onclick = null; // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è§£é™¤

            // ãƒ”ãƒ¼ã‚¹ã‚’å†è¡¨ç¤ºã—ã€ã‚¹ãƒ­ãƒƒãƒˆæ¸ˆã¿ãƒãƒ¼ã‚¯ã‚’è§£é™¤
            partElement.style.display = 'block';
            partElement.classList.remove('slotted');
            
            slottedParts[slotIndex - 1] = null;
        }


        async function checkAnswer() {
            if (slottedParts[0] === null || slottedParts[1] === null) {
                showFeedback('ä¸¡æ–¹ã®ã‚¹ãƒ­ãƒƒãƒˆã‚’åŸ‹ã‚ã¦ãã ã•ã„', 'error');
                return;
            }
            
            isChecking = true;
            gameActionButton.disabled = true;

            const part1 = slottedParts[0];
            const part2 = slottedParts[1];
            
            const isCorrect = (part1.correctSlot === 1 && part2.correctSlot === 2);

            // ã‚¹ãƒ­ãƒƒãƒˆã®è‰²ã‚’æ›´æ–°
            targetSlots[0].classList.add(isCorrect ? 'correct-slot' : 'incorrect-slot');
            targetSlots[1].classList.add(isCorrect ? 'correct-slot' : 'incorrect-slot');

            if (isCorrect) {
                showFeedback('æ­£è§£ï¼', 'success');
                completedCount++;
                
                // æ­£è§£ã—ãŸå˜èªã‚’ completedWordsAreaStep1 ã«ç§»å‹•
                const completedWordElement = document.createElement('div');
                // w-autoã¨px-4ã‚’è¿½åŠ ã—ã€å†…å®¹ã«å¿œã˜ã¦å¹…ã‚’èª¿æ•´
                completedWordElement.className = 'completed-word px-4 py-2 bg-green-500 text-white rounded-full text-xl sm:text-3xl font-bold cursor-pointer';
                completedWordElement.textContent = part1.part + part2.part;
                completedWordElement.dataset.wordId = currentTargetWord.part1 + currentTargetWord.part2; // Step 2ç”¨
                completedWordElement.dataset.translation = currentTargetWord.translation; // Step 2ç”¨
                completedWordsAreaStep1.appendChild(completedWordElement);
                completedWordsAreaStep1.style.display = 'flex'; // è¡¨ç¤ºã•ã›ã‚‹

                // 2ç§’å¾…æ©Ÿ
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                currentWordIndex++;
                isChecking = false;
                gameActionButton.disabled = false;
                
                loadNextWord();
                
            } else {
                misses++;
                showFeedback('é–“é•ã„...', 'error');
                
                // 1.5ç§’å¾…æ©Ÿ
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // ã‚¹ãƒ­ãƒƒãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
                targetSlots[0].classList.remove('incorrect-slot');
                targetSlots[1].classList.remove('incorrect-slot');
                targetSlots[0].textContent = '...';
                targetSlots[1].textContent = '...';
                
                // ãƒ”ãƒ¼ã‚¹ã‚’partsAreaã«æˆ»ã™
                [part1, part2].forEach(p => {
                    p.element.style.display = 'block';
                    p.element.classList.remove('slotted');
                });
                
                slottedParts = [null, null];
                isChecking = false;
                gameActionButton.disabled = false;
            }
        }


        // ----------------------------------------------------------------
        // 7. ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ (Step 2: å˜èªã¨è¨³ã®ãƒãƒƒãƒãƒ³ã‚°)
        // ----------------------------------------------------------------

        let step2Words = [];
        let step2Translations = [];
        let selectedWord = null;
        let selectedTranslation = null;

        function endGame() {
            isGameActive = false;
            currentWordIndex = 0;
            
            // Step 2 ã®æº–å‚™
            // Step 1 ã§å®Œæˆã—ãŸå˜èªãƒªã‚¹ãƒˆã‚’å–å¾—
            step2Words = [];
            document.querySelectorAll('#completed-words-step1 .completed-word').forEach(element => {
                step2Words.push({
                    word: element.dataset.wordId,
                    translation: element.dataset.translation,
                    element: element,
                    isMatched: false
                });
            });

            // è¨³ã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ
            step2Translations = shuffle(step2Words.map(w => ({
                translation: w.translation,
                isMatched: false,
                element: null // å¾Œã§DOMè¦ç´ ã‚’æ ¼ç´
            })));


            // UIã®åˆ‡ã‚Šæ›¿ãˆ
            step1Content.style.display = 'none';
            step2Section.style.display = 'flex'; // flex-col or flex-row
            gameActionButton.textContent = 'ãƒ›ãƒ¼ãƒ ã¸';
            gameActionButton.onclick = () => setView('home');

            // ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ã®è¡¨ç¤º
            gameScoreBoard.style.display = 'flex';
            finalMissDisplay.textContent = misses;
            
            // ãƒãƒƒãƒãƒ³ã‚°ã‚¨ãƒªã‚¢ã®æº–å‚™
            renderStep2Parts();
        }


        function renderStep2Parts() {
            completedWordsAreaStep2.innerHTML = '';
            translationArea.innerHTML = '';
            
            // è‹±èªå˜èªã®æç”»
            step2Words.forEach(wordData => {
                const wordElement = document.createElement('div');
                wordElement.className = 'completed-word px-4 py-2 bg-yellow-400 text-gray-800 rounded-lg text-xl font-bold hover:bg-yellow-500 cursor-pointer';
                wordElement.textContent = wordData.word;
                wordElement.dataset.wordId = wordData.word;
                wordData.element = wordElement;
                
                wordElement.addEventListener('click', () => handleWordClick(wordData));
                completedWordsAreaStep2.appendChild(wordElement);
            });

            // æ—¥æœ¬èªè¨³ã®æç”»
            step2Translations.forEach(translationData => {
                const translationElement = document.createElement('div');
                // w-autoã¨px-4ã‚’è¿½åŠ ã—ã€å†…å®¹ã«å¿œã˜ã¦å¹…ã‚’èª¿æ•´
                translationElement.className = 'translation-part px-4 py-2 bg-green-500 text-white rounded-lg text-xl font-bold hover:bg-green-600 cursor-pointer whitespace-nowrap';
                translationElement.textContent = translationData.translation;
                translationElement.dataset.translation = translationData.translation;
                translationData.element = translationElement;

                translationElement.addEventListener('click', () => handleTranslationClick(translationData));
                translationArea.appendChild(translationElement);
            });
        }
        
        function handleWordClick(wordData) {
            if (wordData.isMatched) return;

            // é¸æŠçŠ¶æ…‹ã®åˆ‡ã‚Šæ›¿ãˆ
            if (selectedWord === wordData) {
                wordData.element.classList.remove('selected');
                selectedWord = null;
            } else {
                if (selectedWord) selectedWord.element.classList.remove('selected');
                selectedWord = wordData;
                wordData.element.classList.add('selected');
            }
            
            checkStep2Match();
        }

        function handleTranslationClick(translationData) {
            if (translationData.isMatched) return;

            // é¸æŠçŠ¶æ…‹ã®åˆ‡ã‚Šæ›¿ãˆ
            if (selectedTranslation === translationData) {
                translationData.element.classList.remove('selected');
                selectedTranslation = null;
            } else {
                if (selectedTranslation) selectedTranslation.element.classList.remove('selected');
                selectedTranslation = translationData;
                translationData.element.classList.add('selected');
            }
            
            checkStep2Match();
        }
        
        async function checkStep2Match() {
            if (!selectedWord || !selectedTranslation) return;
            
            const currentWord = selectedWord.element;
            const currentTranslation = selectedTranslation.element;

            isChecking = true; // ãƒãƒƒãƒãƒ³ã‚°ä¸­ã¯ã‚¯ãƒªãƒƒã‚¯ã‚’ç„¡åŠ¹åŒ–
            
            if (selectedWord.translation === selectedTranslation.translation) {
                // æ­£è§£
                showFeedback('ãƒãƒƒãƒãƒ³ã‚°æˆåŠŸï¼', 'success');
                step2MatchCount++;
                
                // çŠ¶æ…‹ã®æ›´æ–°
                selectedWord.isMatched = true;
                selectedTranslation.isMatched = true;
                
                // UIã®æ›´æ–°
                currentWord.classList.remove('selected', 'bg-yellow-400', 'hover:bg-yellow-500');
                currentWord.classList.add('bg-green-600');
                currentTranslation.classList.remove('selected', 'bg-green-500', 'hover:bg-green-600');
                currentTranslation.classList.add('bg-green-700');
                
                // è¦ç´ ã‚’éè¡¨ç¤ºã«ã™ã‚‹
                currentWord.style.opacity = '0.5';
                currentTranslation.style.opacity = '0.5';

                // æœ€çµ‚ãƒšã‚¢è¡¨ç¤ºã«è¿½åŠ 
                displayFinalPair(selectedWord.word, selectedWord.translation);

                // 1ç§’å¾…æ©Ÿ
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (step2MatchCount === questionLimit) {
                    // å…¨ã¦å®Œäº†
                    showStep2FinalScore();
                }
                
            } else {
                // é–“é•ã„
                misses++;
                showFeedback(`é–“é•ã„ï¼`, 'error');
                
                // ä¸€æ™‚çš„ã«èµ¤ãã™ã‚‹
                currentWord.classList.add('incorrect-part-temp');
                currentTranslation.classList.add('incorrect-part-temp');
                
                // 1.5ç§’å¾…æ©Ÿ
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // å…ƒã®è‰²ã«æˆ»ã™
                currentWord.classList.remove('incorrect-part-temp');
                currentTranslation.classList.remove('incorrect-part-temp');
            }
            
            currentWord.classList.remove('selected');
            currentTranslation.classList.remove('selected');
            selectedWord = null;
            selectedTranslation = null;
            isChecking = false;
        }

        function displayFinalPair(word, translation) {
             const pairElement = document.createElement('div');
             pairElement.className = 'p-3 bg-white rounded-lg shadow-md border-l-4 border-indigo-500 flex justify-between items-center';
             pairElement.innerHTML = `
                 <p class="text-lg font-bold text-gray-800">${word}</p>
                 <p class="text-base text-gray-600 ml-4">(${translation})</p>
             `;
             finalPairsDisplay.appendChild(pairElement);
        }

        function showStep2FinalScore() {
            const finalScoreMessage = document.createElement('div');
            finalScoreMessage.className = 'final-message bg-indigo-100 rounded-xl shadow-lg mt-8 border-t-4 border-indigo-500';
            finalScoreMessage.innerHTML = `
                <p class="text-3xl font-bold text-indigo-700">ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼</p>
                <p class="text-xl text-gray-700 mt-2">æœ€çµ‚ãƒŸã‚¹å›æ•°: <span class="text-4xl text-red-600 font-black">${misses}</span> å›</p>
                <p class="text-sm text-gray-500 mt-1">ç›®æŒ‡ã›ãƒŸã‚¹0å›ï¼</p>
            `;
            finalScoreContainer.innerHTML = '';
            finalScoreContainer.appendChild(finalScoreMessage);
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ä¸‹éƒ¨ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ (è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«)
            setTimeout(() => {
                gameContainer.scrollTop = gameContainer.scrollHeight;
            }, 100);
        }


        // ----------------------------------------------------------------
        // 8. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¨åˆæœŸåŒ–
        // ----------------------------------------------------------------

        // Home View Listeners
        startSelectedThemeButton.addEventListener('click', startGame);
        newThemeButton.addEventListener('click', () => {
            setupNewTheme();
            setView('manager');
        });

        // Manager View Listeners
        addWordButton.addEventListener('click', addWordToTheme);
        saveThemeButton.addEventListener('click', () => saveTheme(editingTheme));
        backToHomeButton.addEventListener('click', () => setView('home'));
        
        // NEW: Import List Listeners
        importListButton.addEventListener('click', handleImportList);


        // Game View Listener
        gameActionButton.addEventListener('click', () => setView('home'));

        window.onload = () => {
             loadThemes();
             setView('home');
        };
    </script>
</body>
</html>