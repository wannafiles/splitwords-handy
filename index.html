<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Split Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* カスタムスタイル */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        /* 画面最大化の適用 (Req 5 & ユーザー要望1) */
        /* bodyのpaddingを削除し、overflow-hiddenも削除して、#game-containerにマージンを移譲 (ユーザー要望2: 画面下部が触れない問題の修正) */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6; 
            width: 100vw;
            height: 100vh;
            /* overflow: hidden; を削除 */
        }
        
        .puzzle-area { min-height: 6rem; } 
        
        /* 単語パーツの共通スタイル */
        .word-part, .completed-word, .translation-part, .theme-item {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-width: 4px; 
            border-style: solid; 
            border-color: transparent;
        }
        
        /* 選択状態のスタイル */
        .selected { 
            box-shadow: 0 6px 12px rgba(79, 70, 229, 0.7); 
            border-color: rgb(79, 70, 229) !important; /* indigo-600 */
        }
        
        .correct-slot { background-color: #34d399 !important; } /* Tailwind green-400 */
        .incorrect-slot { background-color: #f87171 !important; } /* Tailwind red-400 */
        /* エラー時に一時的に赤くするピースのスタイル */
        .incorrect-part-temp { background-color: #fca5a5 !important; } /* Tailwind red-300 */

        /* ターゲットスロットのスタイル調整 */
        .target-slot {
            transition: background-color 0.2s;
            line-height: 5rem; 
            font-weight: 900; 
        }
        
        /* ゲームクリア/オーバー時のメッセージ表示用 */
        .final-message {
            padding: 1rem;
            margin-top: 1rem;
            font-size: 1.5rem; 
            font-weight: 700;
            text-align: center;
        }

        /* マイナスマージンを適用して上部の隙間を最小化 */
        .negative-mt-4 { margin-top: -1rem; } 
        
        /* Tema List specific */
        .theme-item {
            border-left-width: 8px;
            border-left-style: solid;
            border-left-color: #4f46e5;
        }

        .required-label::after {
            content: " *";
            color: #ef4444; /* red-500 */
            margin-left: 0.25rem;
        }
    </style>
</head>
<body class="w-screen h-screen bg-gray-50 text-gray-800 antialiased flex items-start justify-center">

    <div id="game-container" class="w-full h-full mx-auto bg-white p-6 sm:p-10 rounded-3xl shadow-2xl border border-gray-100 flex flex-col space-y-4 max-w-7xl overflow-y-auto my-4 sm:my-8">
        
        <div id="control-area" class="flex flex-col items-center justify-center">
            <h1 id="game-title" class="text-5xl sm:text-6xl font-black text-indigo-800 mb-6 text-center">Word Split Challenge</h1>
        </div>
        
        <div id="home-view" class="space-y-6">
            <h2 class="text-3xl font-bold text-gray-700">テーマ選択 (ローカル保存)</h2>

            <div id="theme-list" class="flex flex-col space-y-3 p-4 bg-gray-50 rounded-xl min-h-40 shadow-inner">
                <p class="text-gray-500 text-center py-10" id="loading-message">テーマをロード中...</p>
            </div>
            
            <div id="question-count-setting" class="p-4 bg-indigo-50 rounded-xl shadow-inner border-t-4 border-indigo-400">
                <label for="question-limit" class="block text-lg font-bold text-gray-700">出題数 (問題)</label>
                <input type="number" id="question-limit" min="5" value="10" class="w-full p-3 border border-gray-300 rounded-lg text-2xl focus:ring-indigo-500 focus:border-indigo-500">
                <p id="max-question-info" class="text-sm text-gray-500 mt-1">最大出題数: 0 (選択したテーマに依存)</p>
            </div>

            <div class="flex flex-col space-y-4">
                <button id="start-selected-theme-button" class="px-6 py-3 bg-green-600 text-white text-xl font-extrabold rounded-xl shadow-md hover:bg-green-700 transition duration-150" disabled>
                    選択したテーマでスタート
                </button>
                <button id="new-theme-button" class="px-6 py-3 bg-indigo-600 text-white text-xl font-extrabold rounded-xl shadow-md hover:bg-indigo-700 transition duration-150">
                    新しいテーマを作成
                </button>
            </div>
            
             <p class="text-sm text-gray-500 pt-4 text-center">このデータはあなたのブラウザに保存されます。</p>
        </div>

        <div id="theme-manager-view" class="space-y-6" style="display: none;">
            <h2 id="manager-title" class="text-3xl font-bold text-gray-700">新しいテーマを作成</h2>
            
            <div class="space-y-4 p-4 bg-gray-100 rounded-xl shadow-lg">

                <label for="theme-name" class="block text-lg font-medium text-gray-700 required-label">テーマ名</label>
                <input type="text" id="theme-name" class="w-full p-3 border border-gray-300 rounded-lg text-2xl focus:ring-indigo-500 focus:border-indigo-500" placeholder="例: ハロウィン単語, 動物の名前">
                <p id="word-count-info" class="text-sm text-gray-500 text-right">単語数: 0 / 最小5単語</p>
                
                <div class="space-y-4 p-4 bg-purple-50 rounded-xl shadow-lg border-t-4 border-purple-400">
                    <h3 class="text-xl font-bold text-purple-700 flex items-center">
                        📋 リスト一括取り込み
                    </h3>
                    <p class="text-sm text-gray-600">
                        外部リストをここに貼り付けて、一括で単語を追加できます。<br>
                        形式: <code>Part1,Part2,日本語訳</code> または <code>FULLWORD,日本語訳</code> (自動で中央付近で分割されます)
                    </p>
                    <textarea id="import-list-textarea" class="w-full p-3 border border-gray-300 rounded-lg h-32 focus:ring-purple-500 focus:border-purple-500 text-sm" placeholder="ここにリストを貼り付けてください..."></textarea>
                    <button id="import-list-button" class="w-full p-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition duration-150" disabled>
                        リストに取り込み実行
                    </button>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-inner space-y-3 border-t-4 border-indigo-400">
                    <h3 class="text-xl font-semibold text-gray-700">単語個別追加フォーム</h3>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 required-label">前半 (Part 1)</label>
                            <input type="text" id="input-part1" class="w-full p-2 border rounded-lg text-lg" placeholder="例: JACK-O'">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 required-label">後半 (Part 2)</label>
                            <input type="text" id="input-part2" class="w-full p-2 border rounded-lg text-lg" placeholder="例: LANTERN">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 required-label">日本語訳</label>
                            <input type="text" id="input-translation" class="w-full p-2 border rounded-lg text-lg" placeholder="例: ジャック・オー・ランタン">
                        </div>
                    </div>
                    <button id="add-word-button" class="w-full p-2 bg-purple-500 text-white font-bold rounded-lg hover:bg-purple-600 transition duration-150" disabled>
                        リストに追加
                    </button>
                </div>
                
                <h3 class="text-xl font-semibold text-gray-700 pt-3">現在の単語リスト</h3>
                <div id="word-list-editor" class="flex flex-col space-y-2 bg-white p-3 rounded-lg min-h-24 max-h-60 overflow-y-auto">
                    <p class="text-gray-400 text-center py-2">単語がありません</p>
                </div>
            </div>

            <div class="flex justify-between space-x-4">
                <button id="back-to-home-button" class="px-6 py-3 bg-gray-500 text-white text-xl font-extrabold rounded-xl shadow-md hover:bg-gray-600 transition duration-150 flex-1">
                    ホームに戻る
                </button>
                <button id="save-theme-button" class="px-6 py-3 bg-pink-600 text-white text-xl font-extrabold rounded-xl shadow-md hover:bg-pink-700 transition duration-150 flex-1" disabled>
                    テーマを保存
                </button>
            </div>
        </div>

        <div id="game-view" style="display: none;">

            <div id="step-1-content" class="negative-mt-4">
                <div id="parts-area" class="puzzle-area flex flex-wrap gap-4 justify-center items-center p-4 bg-gray-50 rounded-xl shadow-inner mb-4">
                    </div>

                <div class="flex flex-col items-center">
                    <div id="target-box" class="flex flex-nowrap justify-center">
                        <div class="target-slot h-24 sm:h-32 bg-gray-200 rounded-l-xl border-4 border-dashed border-gray-400 border-r-0 flex items-center justify-center text-5xl sm:text-7xl font-extrabold text-gray-700 whitespace-nowrap px-4 flex-shrink-0" data-slot="1">...</div>
                        <div class="target-slot h-24 sm:h-32 bg-gray-200 rounded-r-xl border-4 border-dashed border-gray-400 border-l-0 flex items-center justify-center text-5xl sm:text-7xl font-extrabold text-gray-700 whitespace-nowrap px-4 flex-shrink-0" data-slot="2">...</div>
                    </div>
                </div>
                
                <div id="completed-words" style="display: none;">
                </div>
            </div>

            <div id="step-2-section" style="display: none;" class="negative-mt-4">
                
                <div id="game-score-board" class="final-message flex flex-col justify-around items-center p-6 bg-orange-100 rounded-xl shadow-lg mb-8" style="display: none;">
                    <p class="text-2xl sm:text-3xl font-semibold text-gray-700 pt-3">最終ミス回数: <span id="final-miss-display" class="text-5xl sm:text-6xl text-red-600 font-bold">0</span>回</p>
                </div>
                
                <div id="step2-pair-area" class="flex flex-col md:flex-row gap-4 mb-4">
                    
                    <div id="english-word-container" class="md:w-1/2 flex flex-col space-y-2 p-3 bg-yellow-100 rounded-xl shadow-md">
                        <div id="completed-words-step2" class="puzzle-area flex flex-wrap gap-2 justify-center items-center p-3 bg-yellow-400 rounded-xl shadow-lg">
                            </div>
                    </div>

                    <div id="japanese-translation-container" class="md:w-1/2 flex flex-col space-y-2 p-3 bg-green-100 rounded-xl shadow-md">
                        <div id="translation-area" class="puzzle-area flex flex-wrap gap-2 justify-center items-center p-3 bg-green-500 rounded-xl shadow-lg">
                            </div>
                    </div>
                </div>
                
                <div id="final-pairs-display" class="mt-4 flex flex-col space-y-3">
                    </div>

                <div id="final-score-container" class="mt-8"></div>
            </div>

            <div id="game-button-wrapper" class="flex justify-center pt-6">
                <button id="game-action-button" class="px-12 py-5 bg-indigo-600 text-white text-3xl sm:text-5xl font-extrabold rounded-full shadow-xl hover:bg-indigo-700 transition duration-150 w-full max-w-sm">
                    ホームへ
                </button>
            </div>
        </div>

    </div>

    <div id="feedback-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-300">
        <div id="feedback-content" class="px-10 py-6 rounded-2xl text-white text-6xl font-black shadow-2xl transform scale-105 transition-transform duration-300">
        </div>
    </div>


    <script>
        // ----------------------------------------------------------------
        // 1. ローカルストレージ設定
        // ----------------------------------------------------------------
        const LOCAL_STORAGE_KEY = 'word_split_challenge_themes';

        // ----------------------------------------------------------------
        // NEW: デフォルトテーマデータ群 (中1英単語セット & 歴史人物)
        // ----------------------------------------------------------------
        
        // 既存の「中1英単語セット」テーマ
        const DEFAULT_THEME_DATA_EIGO = {
            id: 'default_chu1_eigo',
            name: '中1英単語セット',
            createdAt: new Date().toISOString(),
            words: [
                { part1: 'YOUR', part2: 'SELF', translation: 'あなた自身' },
                { part1: 'FLO', part2: 'WER', translation: '花' },
                { part1: 'CHA', part2: 'NCE', translation: '機会' },
                { part1: 'SCI', part2: 'ENCE', translation: '科学' },
                { part1: 'CIT', part2: 'IZEN', translation: '市民' },
                { part1: 'SUP', part2: 'PER', translation: '夕食' },
                { part1: 'FAT', part2: 'HER', translation: '父' },
                { part1: 'BRO', part2: 'THER', translation: '兄弟' },
                { part1: 'MYS', part2: 'ELF', translation: '私自身を' },
                { part1: 'YEST', part2: 'ERDAY', translation: '昨日' },
                { part1: 'LIB', part2: 'RARY', translation: '図書館' },
                { part1: 'ARR', part2: 'IVE', translation: '到着する' },
                { part1: 'DECE', part2: 'MBER', translation: '１２月' },
                { part1: 'NOTE', part2: 'BOOK', translation: 'ノート' },
                { part1: 'O’C', part2: 'LOCK', translation: '～時' },
                { part1: 'GUI', part2: 'TAR', translation: 'ギター' },
                { part1: 'PRE', part2: 'SENT', translation: 'プレゼント' },
                { part1: 'MOR', part2: 'NING', translation: '朝' },
                { part1: 'HOME', part2: 'WORK', translation: '宿題' },
                { part1: 'MIN', part2: 'UTE', translation: '分，ちょっとの間' },
                { part1: 'CHU', part2: 'RCH', translation: '教会' },
                { part1: 'TOGE', part2: 'THER', translation: '一緒に' },
                { part1: 'LET', part2: 'TER', translation: '手紙' },
                { part1: 'SUN', part2: 'DAY', translation: '日曜日' },
                { part1: 'THE', part2: 'IRS', translation: '彼(女)らのもの' },
                { part1: 'WEDN', part2: 'ESDAY', translation: '水曜日' },
                { part1: 'BASKE', part2: 'TBALL', translation: 'バスケットボール' },
                { part1: 'COMP', part2: 'UTER', translation: 'コンピュータ' },
                { part1: 'SUB', part2: 'JECT', translation: '科目，題目' },
                { part1: 'OCT', part2: 'OBER', translation: '１０月' },
                { part1: 'WEA', part2: 'THER', translation: '天気' },
                { part1: 'DAN', part2: 'GER', translation: '危険' },
                { part1: 'PEN', part2: 'CIL', translation: '鉛筆' },
                { part1: 'JAPA', part2: 'NESE', translation: '日本語' },
                { part1: 'SOC', part2: 'CER', translation: 'サッカー' },
                { part1: 'TEA', part2: 'CHER', translation: '先生' },
                { part1: 'ITS', part2: 'ELF', translation: 'それ自身' },
                { part1: 'INTER', part2: 'ESTING', translation: '興味深い' },
                { part1: 'FRI', part2: 'DAY', translation: '金曜日' },
                { part1: 'HOSP', part2: 'ITAL', translation: '病院' },
                { part1: 'AME', part2: 'RICA', translation: 'アメリカ合衆国' },
                { part1: 'HUN', part2: 'GRY', translation: '空腹の' },
                { part1: 'NOT', part2: 'HING', translation: '何も～ない' },
                { part1: 'BIRT', part2: 'HDAY', translation: '誕生日' },
                { part1: 'SATU', part2: 'RDAY', translation: '土曜日' },
                { part1: 'FRI', part2: 'END', translation: '友人' },
                { part1: 'FEBR', part2: 'UARY', translation: '２月' },
                { part1: 'HIM', part2: 'SELF', translation: '彼自身' },
                { part1: 'BREA', part2: 'KFAST', translation: '朝食' },
                { part1: 'FAM', part2: 'ILY', translation: '家族' },
                { part1: 'DAUG', part2: 'HTER', translation: '娘' },
                { part1: 'SIS', part2: 'TER', translation: '姉妹' },
                { part1: 'CAR', part2: 'EFUL', translation: '注意深い' },
                { part1: 'COL', part2: 'LECT', translation: '集める' },
                { part1: 'MON', part2: 'DAY', translation: '月曜日' },
                { part1: 'SOME', part2: 'TIMES', translation: '時々' },
                { part1: 'JAN', part2: 'UARY', translation: '１月' },
                { part1: 'SEA', part2: 'SON', translation: '季節' },
                { part1: 'HON', part2: 'EST', translation: '正直な' },
                { part1: 'VIL', part2: 'LAGE', translation: '村' },
                { part1: 'TEN', part2: 'NIS', translation: 'テニス' },
                { part1: 'DIN', part2: 'NER', translation: '夕食' },
                { part1: 'TUE', part2: 'SDAY', translation: '火曜日' },
                { part1: 'NOVE', part2: 'MBER', translation: '１１月' },
                { part1: 'SUM', part2: 'MER', translation: '夏' },
                { part1: 'NUM', part2: 'BER', translation: '数' },
                { part1: 'SCH', part2: 'OOL', translation: '学校' },
                { part1: 'FAVO', part2: 'RITE', translation: '一番好きな' },
                { part1: 'ALW', part2: 'AYS', translation: 'いつも' },
                { part1: 'KIT', part2: 'CHEN', translation: '台所' },
                { part1: 'CAN', part2: 'ADA', translation: 'カナダ' },
                { part1: 'NOB', part2: 'ODY', translation: 'だれも～ない' },
                { part1: 'TOMO', part2: 'RROW', translation: '明日' },
                { part1: 'SPR', part2: 'ING', translation: '春' },
                { part1: 'AUSTRA', part2: 'LIA', translation: 'オーストラリア' },
                { part1: 'SOME', part2: 'THING', translation: '何か' },
                { part1: 'AUG', part2: 'UST', translation: '８月' },
                { part1: 'ANI', part2: 'MAL', translation: '動物' },
                { part1: 'AFTE', part2: 'RNOON', translation: '午後' },
                { part1: 'OFF', part2: 'ICE', translation: '事務所' },
                { part1: 'MOT', part2: 'HER', translation: '母' },
                { part1: 'WIN', part2: 'DOW', translation: '窓' },
                { part1: 'SLO', part2: 'WLY', translation: 'ゆっくりと' },
                { part1: 'LIT', part2: 'TLE', translation: '小さい，幼い，ちょっとした' },
                { part1: 'HER', part2: 'SELF', translation: '彼女自身' },
                { part1: 'WIN', part2: 'TER', translation: '冬' },
                { part1: 'THUR', part2: 'SDAY', translation: '木曜日' },
                { part1: 'EVERY', part2: 'THING', translation: 'すべてのもの' },
                { part1: 'O’C', part2: 'LOCK', translation: '～時' },
                { part1: 'PIC', part2: 'TURE', translation: '絵，写真' },
                { part1: 'FRIE', part2: 'NDLY', translation: '親しみやすい' },
                { part1: 'STU', part2: 'DENT', translation: '学生' },
                { part1: 'SEPT', part2: 'EMBER', translation: '９月' },
                { part1: 'STA', part2: 'TION', translation: '駅' },
                { part1: 'FAM', part2: 'OUS', translation: '有名な' },
                { part1: 'BASE', part2: 'BALL', translation: '野球' },
                { part1: 'DOC', part2: 'TOR', translation: '医者' },
                { part1: 'ORA', part2: 'NGE', translation: 'オレンジ' },
                { part1: 'EVERY', part2: 'BODY', translation: 'だれでもみな' },
                { part1: 'SOM', part2: 'EONE', translation: 'だれか' },
                { part1: 'USU', part2: 'ALLY', translation: 'ふつう' },
                { part1: 'RAC', part2: 'KET', translation: 'ラケット' },
                { part1: 'SEC', part2: 'OND', translation: '２日' },
                { part1: 'ALR', part2: 'EADY', translation: 'すでに' },
                { part1: 'EVERY', part2: 'ONE', translation: 'みんな' },
                { part1: 'GAR', part2: 'DEN', translation: '庭' },
                { part1: 'STR', part2: 'ONG', translation: '強い，じょうぶな' },
                { part1: 'EVE', part2: 'NING', translation: '晩' },
                { part1: 'PLA', part2: 'YER', translation: '選手，演奏者' },
                { part1: 'PEO', part2: 'PLE', translation: '人々' },
                { part1: 'BEAU', part2: 'TIFUL', translation: '美しい' },
                { part1: 'CAM', part2: 'ERA', translation: 'カメラ' },
                { part1: 'POP', part2: 'ULAR', translation: '人気のある' },
                { part1: 'ENG', part2: 'LISH', translation: '英語' },
                { part1: 'THEMSE', part2: 'LVES', translation: '彼(女)ら自身' },
                { part1: 'COU', part2: 'NTRY', translation: '国，いなか，地方' },
                { part1: 'PAR', part2: 'ENT', translation: '親' },
                { part1: 'OURS', part2: 'ELVES', translation: '私たち自身を' },
                { part1: 'JUN', part2: 'IOR', translation: '年下の，下級の' },
                { part1: 'QUES', part2: 'TION', translation: '質問' },
                { part1: 'AUT', part2: 'UMN', translation: '秋' },
                { part1: 'SIN', part2: 'GER', translation: '歌手' },
            ]
        };

        // 新しく追加された「歴史人物・用語」テーマ
        const DEFAULT_THEME_DATA_HISTORY = {
            id: 'default_rekishi_jinbutsu',
            name: '歴史人物・用語',
            createdAt: new Date().toISOString(),
            words: [
                // 人物名（全角文字）は、中央で自動分割するロジックに基づいてPart1/Part2に分割しています。
                { part1: '卑', part2: '弥呼', translation: '邪馬台国の女王' },
                { part1: '聖徳', part2: '太子', translation: '冠位十二階' },
                { part1: '鑑', part2: '真', translation: '遣唐使船で来日' },
                { part1: '山上', part2: '憶良', translation: '貧窮問答歌' },
                { part1: '坂上田', part2: '村麻呂', translation: '蝦夷と戦った征夷大将軍' },
                { part1: '藤原', part2: '頼通', translation: '平等院鳳凰堂' },
                { part1: '平', part2: '将門', translation: '新皇と名乗り関東で反乱' },
                { part1: '最', part2: '澄', part2_kana: 'さいちょう', translation: '比叡山・延暦寺・天台宗' },
                { part1: '空', part2: '海', translation: '高野山・金剛峯寺・真言宗' },
                { part1: '紫', part2: '式部', translation: '源氏物語' },
                { part1: '清少', part2: '納言', translation: '枕草子' },
                { part1: '紀', part2: '貫之', translation: '古今和歌集の選者' },
                { part1: '平', part2: '清盛', translation: '太政大臣・武士で政治の実権' },
                { part1: '源', part2: '頼朝', translation: '征夷大将軍・鎌倉幕府を開いた' },
                { part1: '後鳥', part2: '羽上皇', translation: '承久の乱で敗れ、隠岐に流された' },
                { part1: '北条', part2: '泰時', translation: '御成敗式目' },
                { part1: '後醍', part2: '醐天皇', translation: '建武の新政' },
                { part1: '足利', part2: '尊氏', translation: '征夷大将軍・京都に幕府を開いた' },
                { part1: '足利', part2: '義満', translation: '金閣寺を建てた' },
                { part1: '足利', part2: '義政', translation: '銀閣寺を建てた' },
                { part1: '尚', part2: '氏', translation: '琉球王国' },
                { part1: '法', part2: '然', translation: '浄土宗' },
                { part1: '親', part2: '鸞', translation: '浄土真宗' },
                { part1: '吉田', part2: '兼好', translation: '徒然草' },
                { part1: '雪', part2: '舟', translation: '水墨画' },
                { part1: 'フランシコ', part2: '・ザビエル', translation: 'キリスト教・宣教師' },
                { part1: '織田', part2: '信長', translation: '桶狭間の戦い・今川義元を破った' },
                { part1: '豊臣', part2: '秀吉', translation: '1590年に全国を統一' },
                { part1: '千', part2: '利休', translation: '茶の湯' },
                { part1: '徳川', part2: '家康', translation: '江戸幕府を開いた' },
                { part1: '徳川', part2: '家光', translation: '参勤交代' },
                { part1: '徳川', part2: '綱吉', translation: '生類憐みの令' },
                { part1: '徳川', part2: '吉宗', translation: '享保の改革' },
                { part1: '松平', part2: '定信', translation: '寛政の改革' },
                { part1: '水野', part2: '忠邦', translation: '天保の改革' },
                { part1: '井原', part2: '西鶴', translation: '浮世草子「好色一代男」' },
                { part1: '近松門', part2: '左衛門', translation: '人形浄瑠璃「曽根崎心中」' },
                { part1: '歌川', part2: '広重', translation: '浮世絵「東海道五十三次」' },
                { part1: '葛飾', part2: '北斎', translation: '風景画「富嶽三十六景」' },
                { part1: '松尾', part2: '芭蕉', translation: '紀行文「おくのほそ道」' },
                { part1: '本居', part2: '宣長', translation: '古事記伝' },
                { part1: '伊能', part2: '忠敬', translation: '全国を測量' },
                { part1: 'ペ', part2: 'リー', translation: '浦賀沖に来航・開国をせまった' },
                { part1: '井伊', part2: '直弼', translation: '日米修好通商条約を締結' },
                { part1: '徳川', part2: '慶喜', translation: '大政奉還' },
                { part1: '福沢', part2: '諭吉', translation: '「学問のすすめ」' },
                { part1: '西郷', part2: '隆盛', translation: '征韓論で政府を去り、鹿児島で挙兵' },
                { part1: '伊藤', part2: '博文', translation: '初代の内閣総理大臣' },
                { part1: '小村', part2: '寿太郎', translation: '関税自主権の回復' },
                { part1: '田中', part2: '正造', translation: '足尾鉱毒事件' },
            ]
        };

        // 全てのデフォルトテーマを格納する配列
        const ALL_DEFAULT_THEMES = [
            DEFAULT_THEME_DATA_EIGO,
            DEFAULT_THEME_DATA_HISTORY 
        ];


        // ----------------------------------------------------------------
        // 2. DOM要素とアプリケーション状態
        // ----------------------------------------------------------------
        
        // UI Views
        const homeView = document.getElementById('home-view');
        const themeManagerView = document.getElementById('theme-manager-view');
        const gameView = document.getElementById('game-view');
        const managerTitle = document.getElementById('manager-title');
        const gameTitle = document.getElementById('game-title');

        // Home Elements
        const themeList = document.getElementById('theme-list');
        const startSelectedThemeButton = document.getElementById('start-selected-theme-button');
        const newThemeButton = document.getElementById('new-theme-button');
        const loadingMessage = document.getElementById('loading-message');

        // Question Limit Elements
        const questionLimitInput = document.getElementById('question-limit');
        const maxQuestionInfo = document.getElementById('max-question-info');

        // Manager Elements
        const themeNameInput = document.getElementById('theme-name');
        const inputPart1 = document.getElementById('input-part1');
        const inputPart2 = document.getElementById('input-part2');
        const inputTranslation = document.getElementById('input-translation');
        const addWordButton = document.getElementById('add-word-button');
        const wordListEditor = document.getElementById('word-list-editor');
        const saveThemeButton = document.getElementById('save-theme-button');
        const backToHomeButton = document.getElementById('back-to-home-button');
        const wordCountInfo = document.getElementById('word-count-info');

        // Import Elements
        const importListTextarea = document.getElementById('import-list-textarea');
        const importListButton = document.getElementById('import-list-button');

        // Game Elements (既存)
        const partsArea = document.getElementById('parts-area');
        const targetSlots = document.querySelectorAll('.target-slot');
        const completedWordsAreaStep1 = document.getElementById('completed-words');
        const completedWordsAreaStep2 = document.getElementById('completed-words-step2');
        const translationArea = document.getElementById('translation-area');
        const gameActionButton = document.getElementById('game-action-button');
        const gameButtonWrapper = document.getElementById('game-button-wrapper');
        const gameScoreBoard = document.getElementById('game-score-board');
        const finalMissDisplay = document.getElementById('final-miss-display');
        const step1Content = document.getElementById('step-1-content');
        const step2Section = document.getElementById('step-2-section');
        const finalPairsDisplay = document.getElementById('final-pairs-display');
        const step2PairArea = document.getElementById('step2-pair-area');
        const finalScoreContainer = document.getElementById('final-score-container');
        
        // Feedback
        const feedbackOverlay = document.getElementById('feedback-overlay');
        const feedbackContent = document.getElementById('feedback-content');

        // アプリケーション状態
        let currentView = 'home';
        let allThemes = [];
        let selectedTheme = null;
        let editingTheme = { id: null, name: '', words: [] };
        let questionLimit = 10;

        // ゲーム状態
        let gameWordData = [];
        let misses = 0;
        let completedCount = 0;
        let step2MatchCount = 0;
        let isGameActive = false;
        let isChecking = false;
        let slottedParts = [null, null];

        // ----------------------------------------------------------------
        // 3. UI/View 制御 & ユーティリティ
        // ----------------------------------------------------------------

        function setView(view) {
            currentView = view;
            homeView.style.display = 'none';
            themeManagerView.style.display = 'none';
            gameView.style.display = 'none';

            // Req 1: タイトル表示の制御
            if (view === 'game') {
                gameTitle.style.display = 'none';
            } else {
                gameTitle.style.display = 'block';
            }

            if (view === 'home') {
                homeView.style.display = 'block';
                selectedTheme = null;
                startSelectedThemeButton.disabled = true;
                loadThemes(); 
            } else if (view === 'manager') {
                themeManagerView.style.display = 'block';
                // テキストエリアをクリア
                importListTextarea.value = '';
                importListButton.disabled = true;
                updateManagerUI();
            } else if (view === 'game') {
                gameView.style.display = 'block';
            }
        }

        function logFeedback(text, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${text}`);
        }

        function showFeedback(message, type) {
            feedbackContent.className = 'px-10 py-6 rounded-2xl text-white text-6xl font-black shadow-2xl transform scale-105 transition-transform duration-300';
            if (type === 'success') {
                feedbackContent.textContent = '✅ ' + message;
                feedbackContent.classList.add('bg-green-600');
            } else if (type === 'error') {
                feedbackContent.textContent = '❌ ' + message;
                feedbackContent.classList.add('bg-red-600');
            }
            feedbackOverlay.classList.remove('opacity-0', 'pointer-events-none');
            
            setTimeout(() => {
                feedbackOverlay.classList.add('opacity-0', 'pointer-events-none');
            }, 1500);
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // ----------------------------------------------------------------
        // 4. テーマの永続化 (localStorage)
        // ----------------------------------------------------------------

        function generateUniqueId() {
            return 'theme_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function saveThemesToLocal() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allThemes));
                logFeedback('Themes successfully saved to localStorage.', 'local');
            } catch (e) {
                logFeedback(`Error saving to localStorage: ${e.message}`, 'error');
                showFeedback('データの保存に失敗しました。', 'error');
            }
        }

        function loadThemes() {
            loadingMessage.style.display = 'block';
            loadingMessage.textContent = 'テーマをロード中...';

            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                let loadedThemes = data ? JSON.parse(data) : [];

                // デフォルトテーマをロード
                ALL_DEFAULT_THEMES.forEach(defaultTheme => {
                    const exists = loadedThemes.some(theme => theme.id === defaultTheme.id);
                    if (!exists) {
                        loadedThemes.push(defaultTheme);
                    }
                });

                allThemes = loadedThemes;
                renderThemeList();
                logFeedback(`Themes loaded: ${allThemes.length} items.`, 'local');

            } catch (e) {
                logFeedback(`Error loading themes: ${e.message}`, 'error');
                showFeedback('テーマの読み込みに失敗しました。', 'error');
            } finally {
                loadingMessage.style.display = 'none';
                if (allThemes.length === 0) {
                    loadingMessage.textContent = 'テーマがありません。新しいテーマを作成してください。';
                    loadingMessage.style.display = 'block';
                }
            }
        }

        function renderThemeList() {
            themeList.innerHTML = '';
            if (allThemes.length === 0) {
                loadingMessage.textContent = 'テーマがありません。新しいテーマを作成してください。';
                loadingMessage.style.display = 'block';
                return;
            }

            allThemes.forEach(theme => {
                const themeElement = document.createElement('div');
                themeElement.className = `theme-item p-4 rounded-xl shadow cursor-pointer transition duration-150 flex justify-between items-center ${selectedTheme && selectedTheme.id === theme.id ? 'bg-indigo-200 border-indigo-600' : 'bg-white hover:bg-gray-100 border-gray-200'}`;
                themeElement.dataset.themeId = theme.id;
                
                const wordCount = theme.words ? theme.words.length : 0;
                
                themeElement.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <p class="text-xl font-bold text-indigo-700 truncate">${theme.name}</p>
                        <p class="text-sm text-gray-500">${wordCount} 単語 (${new Date(theme.createdAt).toLocaleDateString()})</p>
                    </div>
                    <div class="flex space-x-2 ml-4">
                         <button data-action="edit" class="p-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 text-sm font-semibold transition duration-150">
                            編集
                        </button>
                        ${theme.id.startsWith('default_') ? 
                            `<button class="p-2 bg-gray-400 text-white rounded-lg text-sm font-semibold cursor-not-allowed" disabled>削除</button>` :
                            `<button data-action="delete" class="p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm font-semibold transition duration-150">削除</button>`
                        }
                    </div>
                `;

                themeElement.addEventListener('click', (e) => {
                    if (e.target.dataset.action === 'edit') {
                        setupEditTheme(theme);
                        setView('manager');
                    } else if (e.target.dataset.action === 'delete') {
                        deleteTheme(theme.id, theme.name);
                    } else {
                        selectTheme(theme);
                    }
                });

                themeList.appendChild(themeElement);
            });
            
            // 選択状態の復元
            if (selectedTheme) {
                selectTheme(selectedTheme);
            }
        }

        function selectTheme(theme) {
            selectedTheme = theme;
            startSelectedThemeButton.disabled = false;
            
            // 最大出題数の表示を更新
            const maxWords = selectedTheme.words.length;
            maxQuestionInfo.textContent = `最大出題数: ${maxWords} (選択したテーマに依存)`;
            questionLimitInput.max = maxWords;
            if (parseInt(questionLimitInput.value) > maxWords) {
                questionLimitInput.value = maxWords > 0 ? maxWords : 5;
            }

            // UIの選択状態を更新
            document.querySelectorAll('.theme-item').forEach(el => {
                if (el.dataset.themeId === theme.id) {
                    el.classList.add('bg-indigo-200', 'border-indigo-600');
                    el.classList.remove('bg-white', 'hover:bg-gray-100', 'border-gray-200');
                } else {
                    el.classList.remove('bg-indigo-200', 'border-indigo-600');
                    el.classList.add('bg-white', 'hover:bg-gray-100', 'border-gray-200');
                }
            });
        }
        
        function deleteTheme(id, name) {
            if (confirm(`本当にテーマ「${name}」を削除しますか？\nこの操作は元に戻せません。`)) {
                allThemes = allThemes.filter(theme => theme.id !== id);
                if (selectedTheme && selectedTheme.id === id) {
                    selectedTheme = null;
                    startSelectedThemeButton.disabled = true;
                    maxQuestionInfo.textContent = '最大出題数: 0 (選択したテーマに依存)';
                }
                saveThemesToLocal();
                renderThemeList();
                showFeedback('テーマを削除しました', 'success');
            }
        }

        // ----------------------------------------------------------------
        // 5. テーマ管理 (Manager View) 
        // ----------------------------------------------------------------

        function setupNewTheme() {
            editingTheme = { id: generateUniqueId(), name: '', words: [] };
            themeNameInput.value = '';
            managerTitle.textContent = '新しいテーマを作成';
            updateManagerUI();
        }

        function setupEditTheme(theme) {
            editingTheme = JSON.parse(JSON.stringify(theme)); // deep copy
            themeNameInput.value = editingTheme.name;
            managerTitle.textContent = `テーマ「${editingTheme.name}」を編集`;
            updateManagerUI();
        }

        function updateManagerUI() {
            // 単語リストの表示
            wordListEditor.innerHTML = '';
            const words = editingTheme.words;

            if (words.length === 0) {
                wordListEditor.innerHTML = '<p class="text-gray-400 text-center py-2">単語がありません</p>';
                saveThemeButton.disabled = true;
            } else {
                words.forEach((word, index) => {
                    const wordElement = document.createElement('div');
                    wordElement.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-lg border border-gray-200';
                    wordElement.innerHTML = `
                        <p class="text-sm font-medium text-gray-800 flex-1 min-w-0 break-all">${word.part1} | ${word.part2} <span class="text-gray-500 ml-2">(${word.translation})</span></p>
                        <button data-index="${index}" data-action="remove" class="ml-4 p-1 text-red-500 hover:text-red-700 transition duration-150">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    `;
                    wordListEditor.appendChild(wordElement);
                });
                
                // 編集中のテーマが有効かチェック
                checkThemeValidity();
            }

            // 単語数の表示更新
            wordCountInfo.textContent = `単語数: ${words.length} / 最小5単語`;
            
            // リスナーの再設定 (動的生成された削除ボタン)
            wordListEditor.querySelectorAll('button[data-action="remove"]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    removeWordFromTheme(index);
                });
            });
        }

        function checkThemeValidity() {
            const isValid = editingTheme.words.length >= 5 && editingTheme.name.trim() !== '';
            saveThemeButton.disabled = !isValid;
        }

        function addWordToTheme() {
            const part1 = inputPart1.value.trim();
            const part2 = inputPart2.value.trim();
            const translation = inputTranslation.value.trim();

            if (!part1 || !part2 || !translation) {
                showFeedback('全てのフィールドを入力してください', 'error');
                return;
            }
            
            const newWord = { part1: part1, part2: part2, translation: translation };

            // 重複チェック
            const fullWord = part1 + part2;
            if (editingTheme.words.some(w => w.part1 + w.part2 === fullWord)) {
                showFeedback('同じ単語は既に追加されています', 'error');
                return;
            }

            editingTheme.words.push(newWord);
            updateManagerUI();

            // フォームのクリア
            inputPart1.value = '';
            inputPart2.value = '';
            inputTranslation.value = '';
            inputPart1.focus();

            showFeedback('単語を追加しました', 'success');
        }

        function removeWordFromTheme(index) {
            editingTheme.words.splice(index, 1);
            updateManagerUI();
        }

        function saveTheme(themeToSave) {
            themeToSave.name = themeNameInput.value.trim();

            if (themeToSave.name === '') {
                showFeedback('テーマ名を入力してください', 'error');
                return;
            }

            if (themeToSave.words.length < 5) {
                 showFeedback('最低5単語必要です。', 'error');
                return;
            }

            // 既存のテーマを更新または新しいテーマを追加
            const existingIndex = allThemes.findIndex(t => t.id === themeToSave.id);
            if (existingIndex !== -1) {
                // 更新
                allThemes[existingIndex] = themeToSave;
                showFeedback('テーマを更新しました', 'success');
            } else {
                // 新規追加
                themeToSave.createdAt = new Date().toISOString();
                allThemes.push(themeToSave);
                showFeedback('新しいテーマを保存しました', 'success');
            }

            saveThemesToLocal();
            setView('home'); // ホームに戻る
        }
        
        function handleImportList() {
            const listText = importListTextarea.value.trim();
            if (!listText) return;

            const lines = listText.split('\n').filter(line => line.trim() !== '');
            let importedCount = 0;

            lines.forEach(line => {
                const parts = line.split(',').map(p => p.trim());
                let part1, part2, translation;

                if (parts.length === 3) {
                    // Part1, Part2, 日本語訳 の形式
                    [part1, part2, translation] = parts;
                } else if (parts.length === 2) {
                    // FULLWORD, 日本語訳 の形式
                    const fullWord = parts[0];
                    translation = parts[1];
                    // 中央付近で分割
                    const splitIndex = Math.ceil(fullWord.length / 2);
                    part1 = fullWord.substring(0, splitIndex);
                    part2 = fullWord.substring(splitIndex);
                } else {
                    return; // 無効な行はスキップ
                }

                if (part1 && part2 && translation) {
                    const fullWord = part1 + part2;
                     // 重複チェック
                    if (editingTheme.words.some(w => w.part1 + w.part2 === fullWord)) {
                        return; // 重複はスキップ
                    }
                    editingTheme.words.push({ part1, part2, translation });
                    importedCount++;
                }
            });

            if (importedCount > 0) {
                updateManagerUI();
                importListTextarea.value = ''; // テキストエリアをクリア
                showFeedback(`${importedCount}個の単語を取り込みました`, 'success');
            } else {
                showFeedback('有効な単語は見つかりませんでした', 'error');
            }
        }
        
        // 監視: テーマ名、個別入力フォーム、一括入力フォーム
        themeNameInput.addEventListener('input', checkThemeValidity);
        
        inputPart1.addEventListener('input', () => {
             addWordButton.disabled = !(inputPart1.value.trim() && inputPart2.value.trim() && inputTranslation.value.trim());
        });
        inputPart2.addEventListener('input', () => {
             addWordButton.disabled = !(inputPart1.value.trim() && inputPart2.value.trim() && inputTranslation.value.trim());
        });
        inputTranslation.addEventListener('input', () => {
             addWordButton.disabled = !(inputPart1.value.trim() && inputPart2.value.trim() && inputTranslation.value.trim());
        });

        importListTextarea.addEventListener('input', () => {
            importListButton.disabled = importListTextarea.value.trim() === '';
        });


        // ----------------------------------------------------------------
        // 6. ゲームロジック (Step 1: 単語パーツの組み立て)
        // ----------------------------------------------------------------

        function startGame() {
            if (!selectedTheme || selectedTheme.words.length < 5) {
                showFeedback('有効なテーマを選択してください (5単語以上)', 'error');
                return;
            }
            
            // 状態のリセット
            questionLimit = Math.min(parseInt(questionLimitInput.value), selectedTheme.words.length);
            misses = 0;
            completedCount = 0;
            step2MatchCount = 0;
            isGameActive = true;
            slottedParts = [null, null];

            // UIのリセット
            partsArea.innerHTML = '';
            completedWordsAreaStep1.innerHTML = '';
            completedWordsAreaStep1.style.display = 'none';
            gameScoreBoard.style.display = 'none';
            step1Content.style.display = 'block';
            step2Section.style.display = 'none';
            gameActionButton.textContent = '次の問題へ';
            gameActionButton.onclick = checkAnswer; // クリックで次の問題へ進む（最初は回答チェック）

            // 出題する単語の選択とシャッフル
            const allWords = shuffle(selectedTheme.words);
            gameWordData = allWords.slice(0, questionLimit);

            // ステージの開始
            loadNextWord();
            setView('game');
        }

        let currentWordIndex = 0;
        let currentTargetWord = null;
        let availableParts = [];
        let selectedPartElement = null;

        function loadNextWord() {
            if (currentWordIndex >= questionLimit) {
                endGame();
                return;
            }

            currentTargetWord = gameWordData[currentWordIndex];
            availableParts = shuffle([
                { part: currentTargetWord.part1, slot: 1, element: null },
                { part: currentTargetWord.part2, slot: 2, element: null }
            ]);

            // UIの更新
            partsArea.innerHTML = '';
            targetSlots[0].textContent = '...';
            targetSlots[1].textContent = '...';
            targetSlots[0].classList.remove('correct-slot', 'incorrect-slot');
            targetSlots[1].classList.remove('correct-slot', 'incorrect-slot');
            
            slottedParts = [null, null];
            selectedPartElement = null;
            
            gameActionButton.textContent = '回答チェック';
            gameActionButton.onclick = checkAnswer; 
            
            renderParts();
        }
        
        function renderParts() {
            partsArea.innerHTML = '';
            availableParts.forEach(wordPart => {
                const partElement = document.createElement('div');
                // w-autoとpx-4を追加し、内容に応じて幅を調整
                partElement.className = 'word-part px-4 py-2 bg-indigo-500 text-white rounded-lg text-xl sm:text-3xl font-bold hover:bg-indigo-600';
                partElement.textContent = wordPart.part;
                partElement.dataset.slot = wordPart.slot; // 正しいスロット
                
                partElement.addEventListener('click', () => handlePartClick(partElement, wordPart));
                
                wordPart.element = partElement;
                partsArea.appendChild(partElement);
            });
        }
        
        function handlePartClick(element, partData) {
            if (isChecking || element.classList.contains('slotted')) return;
            
            // 選択/選択解除の処理
            if (selectedPartElement === element) {
                element.classList.remove('selected');
                selectedPartElement = null;
            } else {
                // 前の選択を解除
                if (selectedPartElement) {
                    selectedPartElement.classList.remove('selected');
                }
                // 新しいピースを選択
                selectedPartElement = element;
                element.classList.add('selected');
            }
            
            // スロットへの配置を試みる
            if (selectedPartElement) {
                // 1. スロット1が空いていれば、そこに配置
                if (!slottedParts[0]) {
                    placePart(element, partData, 1);
                } 
                // 2. スロット1が埋まっていて、スロット2が空いていれば、そこに配置
                else if (!slottedParts[1]) {
                    placePart(element, partData, 2);
                } 
                // 3. 両方埋まっている場合、現在の選択を解除するだけにする
                else {
                    // 何もしない（または、すでに配置されているピースをタップで戻すロジックを追加可能）
                }
            }
        }
        
        function placePart(element, partData, slotIndex) {
            const targetSlot = targetSlots[slotIndex - 1]; // targetSlotsは0-indexed
            
            // スロットに配置
            targetSlot.textContent = partData.part;
            targetSlot.dataset.partId = partData.part; // 配置されたピースを識別
            
            // 選択状態を解除し、スロット済みとしてマーク
            element.classList.remove('selected');
            element.classList.add('slotted');
            element.style.display = 'none'; // ピースを非表示にする
            
            // 状態を更新
            slottedParts[slotIndex - 1] = { part: partData.part, correctSlot: partData.slot, element: element };
            selectedPartElement = null;
            
            // スロットからピースを取り戻すロジック
            targetSlot.onclick = () => removePart(slotIndex, targetSlot, element);
            
            // 両方のスロットが埋まったら、自動で回答チェックに進むように促す
            if (slottedParts[0] && slottedParts[1]) {
                 gameActionButton.textContent = '回答チェック';
                 checkAnswer(); 
            }
        }
        
        function removePart(slotIndex, targetSlot, partElement) {
            if (isChecking) return;
            
            targetSlot.textContent = '...';
            targetSlot.dataset.partId = ''; 
            targetSlot.onclick = null; // クリックイベントを解除

            // ピースを再表示し、スロット済みマークを解除
            partElement.style.display = 'block';
            partElement.classList.remove('slotted');
            
            slottedParts[slotIndex - 1] = null;
        }


        async function checkAnswer() {
            if (slottedParts[0] === null || slottedParts[1] === null) {
                showFeedback('両方のスロットを埋めてください', 'error');
                return;
            }
            
            isChecking = true;
            gameActionButton.disabled = true;

            const part1 = slottedParts[0];
            const part2 = slottedParts[1];
            
            const isCorrect = (part1.correctSlot === 1 && part2.correctSlot === 2);

            // スロットの色を更新
            targetSlots[0].classList.add(isCorrect ? 'correct-slot' : 'incorrect-slot');
            targetSlots[1].classList.add(isCorrect ? 'correct-slot' : 'incorrect-slot');

            if (isCorrect) {
                showFeedback('正解！', 'success');
                completedCount++;
                
                // 正解した単語を completedWordsAreaStep1 に移動
                const completedWordElement = document.createElement('div');
                // w-autoとpx-4を追加し、内容に応じて幅を調整
                completedWordElement.className = 'completed-word px-4 py-2 bg-green-500 text-white rounded-full text-xl sm:text-3xl font-bold cursor-pointer';
                completedWordElement.textContent = part1.part + part2.part;
                completedWordElement.dataset.wordId = currentTargetWord.part1 + currentTargetWord.part2; // Step 2用
                completedWordElement.dataset.translation = currentTargetWord.translation; // Step 2用
                completedWordsAreaStep1.appendChild(completedWordElement);
                completedWordsAreaStep1.style.display = 'flex'; // 表示させる

                // 2秒待機
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                currentWordIndex++;
                isChecking = false;
                gameActionButton.disabled = false;
                
                loadNextWord();
                
            } else {
                misses++;
                showFeedback('間違い...', 'error');
                
                // 1.5秒待機
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // スロットをリセット
                targetSlots[0].classList.remove('incorrect-slot');
                targetSlots[1].classList.remove('incorrect-slot');
                targetSlots[0].textContent = '...';
                targetSlots[1].textContent = '...';
                
                // ピースをpartsAreaに戻す
                [part1, part2].forEach(p => {
                    p.element.style.display = 'block';
                    p.element.classList.remove('slotted');
                });
                
                slottedParts = [null, null];
                isChecking = false;
                gameActionButton.disabled = false;
            }
        }


        // ----------------------------------------------------------------
        // 7. ゲームロジック (Step 2: 単語と訳のマッチング)
        // ----------------------------------------------------------------

        let step2Words = [];
        let step2Translations = [];
        let selectedWord = null;
        let selectedTranslation = null;

        function endGame() {
            isGameActive = false;
            currentWordIndex = 0;
            
            // Step 2 の準備
            // Step 1 で完成した単語リストを取得
            step2Words = [];
            document.querySelectorAll('#completed-words-step1 .completed-word').forEach(element => {
                step2Words.push({
                    word: element.dataset.wordId,
                    translation: element.dataset.translation,
                    element: element,
                    isMatched: false
                });
            });

            // 訳のリストを作成
            step2Translations = shuffle(step2Words.map(w => ({
                translation: w.translation,
                isMatched: false,
                element: null // 後でDOM要素を格納
            })));


            // UIの切り替え
            step1Content.style.display = 'none';
            step2Section.style.display = 'flex'; // flex-col or flex-row
            gameActionButton.textContent = 'ホームへ';
            gameActionButton.onclick = () => setView('home');

            // スコアボードの表示
            gameScoreBoard.style.display = 'flex';
            finalMissDisplay.textContent = misses;
            
            // マッチングエリアの準備
            renderStep2Parts();
        }


        function renderStep2Parts() {
            completedWordsAreaStep2.innerHTML = '';
            translationArea.innerHTML = '';
            
            // 英語単語の描画
            step2Words.forEach(wordData => {
                const wordElement = document.createElement('div');
                wordElement.className = 'completed-word px-4 py-2 bg-yellow-400 text-gray-800 rounded-lg text-xl font-bold hover:bg-yellow-500 cursor-pointer';
                wordElement.textContent = wordData.word;
                wordElement.dataset.wordId = wordData.word;
                wordData.element = wordElement;
                
                wordElement.addEventListener('click', () => handleWordClick(wordData));
                completedWordsAreaStep2.appendChild(wordElement);
            });

            // 日本語訳の描画
            step2Translations.forEach(translationData => {
                const translationElement = document.createElement('div');
                // w-autoとpx-4を追加し、内容に応じて幅を調整
                translationElement.className = 'translation-part px-4 py-2 bg-green-500 text-white rounded-lg text-xl font-bold hover:bg-green-600 cursor-pointer whitespace-nowrap';
                translationElement.textContent = translationData.translation;
                translationElement.dataset.translation = translationData.translation;
                translationData.element = translationElement;

                translationElement.addEventListener('click', () => handleTranslationClick(translationData));
                translationArea.appendChild(translationElement);
            });
        }
        
        function handleWordClick(wordData) {
            if (wordData.isMatched) return;

            // 選択状態の切り替え
            if (selectedWord === wordData) {
                wordData.element.classList.remove('selected');
                selectedWord = null;
            } else {
                if (selectedWord) selectedWord.element.classList.remove('selected');
                selectedWord = wordData;
                wordData.element.classList.add('selected');
            }
            
            checkStep2Match();
        }

        function handleTranslationClick(translationData) {
            if (translationData.isMatched) return;

            // 選択状態の切り替え
            if (selectedTranslation === translationData) {
                translationData.element.classList.remove('selected');
                selectedTranslation = null;
            } else {
                if (selectedTranslation) selectedTranslation.element.classList.remove('selected');
                selectedTranslation = translationData;
                translationData.element.classList.add('selected');
            }
            
            checkStep2Match();
        }
        
        async function checkStep2Match() {
            if (!selectedWord || !selectedTranslation) return;
            
            const currentWord = selectedWord.element;
            const currentTranslation = selectedTranslation.element;

            isChecking = true; // マッチング中はクリックを無効化
            
            if (selectedWord.translation === selectedTranslation.translation) {
                // 正解
                showFeedback('マッチング成功！', 'success');
                step2MatchCount++;
                
                // 状態の更新
                selectedWord.isMatched = true;
                selectedTranslation.isMatched = true;
                
                // UIの更新
                currentWord.classList.remove('selected', 'bg-yellow-400', 'hover:bg-yellow-500');
                currentWord.classList.add('bg-green-600');
                currentTranslation.classList.remove('selected', 'bg-green-500', 'hover:bg-green-600');
                currentTranslation.classList.add('bg-green-700');
                
                // 要素を非表示にする
                currentWord.style.opacity = '0.5';
                currentTranslation.style.opacity = '0.5';

                // 最終ペア表示に追加
                displayFinalPair(selectedWord.word, selectedWord.translation);

                // 1秒待機
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (step2MatchCount === questionLimit) {
                    // 全て完了
                    showStep2FinalScore();
                }
                
            } else {
                // 間違い
                misses++;
                showFeedback(`間違い！`, 'error');
                
                // 一時的に赤くする
                currentWord.classList.add('incorrect-part-temp');
                currentTranslation.classList.add('incorrect-part-temp');
                
                // 1.5秒待機
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // 元の色に戻す
                currentWord.classList.remove('incorrect-part-temp');
                currentTranslation.classList.remove('incorrect-part-temp');
            }
            
            currentWord.classList.remove('selected');
            currentTranslation.classList.remove('selected');
            selectedWord = null;
            selectedTranslation = null;
            isChecking = false;
        }

        function displayFinalPair(word, translation) {
             const pairElement = document.createElement('div');
             pairElement.className = 'p-3 bg-white rounded-lg shadow-md border-l-4 border-indigo-500 flex justify-between items-center';
             pairElement.innerHTML = `
                 <p class="text-lg font-bold text-gray-800">${word}</p>
                 <p class="text-base text-gray-600 ml-4">(${translation})</p>
             `;
             finalPairsDisplay.appendChild(pairElement);
        }

        function showStep2FinalScore() {
            const finalScoreMessage = document.createElement('div');
            finalScoreMessage.className = 'final-message bg-indigo-100 rounded-xl shadow-lg mt-8 border-t-4 border-indigo-500';
            finalScoreMessage.innerHTML = `
                <p class="text-3xl font-bold text-indigo-700">お疲れ様でした！ゲームクリア！</p>
                <p class="text-xl text-gray-700 mt-2">最終ミス回数: <span class="text-4xl text-red-600 font-black">${misses}</span> 回</p>
                <p class="text-sm text-gray-500 mt-1">目指せミス0回！</p>
            `;
            finalScoreContainer.innerHTML = '';
            finalScoreContainer.appendChild(finalScoreMessage);
            
            // スクロールで下部が見えるようにする (自動スクロール)
            setTimeout(() => {
                gameContainer.scrollTop = gameContainer.scrollHeight;
            }, 100);
        }


        // ----------------------------------------------------------------
        // 8. イベントリスナーと初期化
        // ----------------------------------------------------------------

        // Home View Listeners
        startSelectedThemeButton.addEventListener('click', startGame);
        newThemeButton.addEventListener('click', () => {
            setupNewTheme();
            setView('manager');
        });

        // Manager View Listeners
        addWordButton.addEventListener('click', addWordToTheme);
        saveThemeButton.addEventListener('click', () => saveTheme(editingTheme));
        backToHomeButton.addEventListener('click', () => setView('home'));
        
        // NEW: Import List Listeners
        importListButton.addEventListener('click', handleImportList);


        // Game View Listener
        gameActionButton.addEventListener('click', () => setView('home'));

        window.onload = () => {
             loadThemes();
             setView('home');
        };
    </script>
</body>
</html>